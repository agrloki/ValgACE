# Решение проблем ValgACE

Руководство по решению типичных проблем при работе с ValgACE.

## Содержание

1. [Устройство не подключается](#устройство-не-подключается)
2. [Проблемы с парковкой](#проблемы-с-парковкой)
3. [Проблемы со сменой инструмента](#проблемы-со-сменой-инструмента)
4. [Проблемы с подачей/откатом](#проблемы-с-подачейоткатом)
5. [Проблемы с сушкой](#проблемы-с-сушкой)
6. [Проблемы производительности](#проблемы-производительности)
7. [Диагностика подключения](#диагностика-подключения)

---

## Устройство не подключается

### Симптомы

- Статус показывает `disconnected`
- Команды не выполняются
- В логах ошибки подключения

### Решения

#### 1. Проверка USB подключения

```bash
# Проверить, видит ли система устройство
lsusb | grep -i anycubic

# Должно показать устройство с VID:PID 28e9:018a
```

Если устройство не видно:
- Проверьте USB кабель
- Попробуйте другой USB порт
- Проверьте питание устройства ACE

#### 2. Проверка порта

```bash
# Посмотреть все USB устройства
ls -la /dev/serial/by-id/

# Должно быть устройство типа:
# usb-ANYCUBIC_ACE_1-if00 -> ../../ttyACM0
```

**Если устройства нет:**
- Устройство не определяется системой
- Проверьте права доступа: `sudo chmod 666 /dev/ttyACM0` (временно)

#### 3. Проверка конфигурации

Убедитесь, что в `ace.cfg` указан правильный порт:

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
```

**Или используйте автопоиск:**
```ini
[ace]
# serial не указан - модуль попытается найти автоматически
baud: 115200
```

#### 4. Проверка прав доступа

```bash
# Добавить пользователя в группу dialout
sudo usermod -a -G dialout $USER

# Перелогиниться для применения изменений
```

#### 5. Проверка занятости порта

```bash
# Проверить, не используется ли порт другим процессом
lsof /dev/ttyACM0
```

Если порт занят - завершите процесс или перезапустите Klipper.

---

## Проблемы с парковкой

### Симптом: Парковка не завершается

**Возможные причины:**

1. **Филамент не достигает сопла**
   - Проверьте, что филамент свободно проходит через весь путь
   - Проверьте натяжение филамента в ACE
   - Убедитесь, что хотенд нагрет до рабочей температуры

2. **Слишком высокий `park_hit_count`**
   ```ini
   # Уменьшите значение в ace.cfg
   park_hit_count: 3  # Вместо 5
   ```

3. **Проблемы с концевым выключателем**
   - Проверьте работу концевика в сопле
   - Убедитесь, что он правильно подключен

**Диагностика:**
```gcode
# Проверить статус парковки
ACE_STATUS

# Смотрите значение feed_assist_count
# Оно должно увеличиваться при парковке
```

### Симптом: Парковка завершается слишком быстро

**Решение:**
```ini
# Увеличьте park_hit_count
park_hit_count: 7  # Вместо 5
```

### Симптом: Ошибка "Feed assist not working"

**Причины:**
- Филамент застрял в пути
- Проблемы с механизмом ACE
- Нет филамента в слоте

**Решение:**
1. Проверьте наличие филамента в слоте
2. Проверьте статус слота: `ACE_STATUS`
3. Попробуйте ручную подачу: `ACE_FEED INDEX=0 LENGTH=50 SPEED=20`
4. Если проблема сохраняется - проверьте механику ACE

---

## Проблемы со сменой инструмента

### Симптом: Смена инструмента зависает

**Диагностика:**
```bash
# Проверить логи
tail -f ~/printer_data/logs/klippy.log | grep -i "toolchange\|park"
```

**Возможные причины:**

1. **Слот не готов после отката**
   - Увеличьте время ожидания
   - Проверьте, что откат завершился полностью

2. **Парковка не завершается**
   - См. раздел "Проблемы с парковкой"

3. **Ошибка в макросах**
   - Проверьте макросы `_ACE_PRE_TOOLCHANGE` и `_ACE_POST_TOOLCHANGE`
   - Убедитесь, что они не блокируют выполнение

**Решение:**
```gcode
# Попробовать ручную смену
ACE_CHANGE_TOOL TOOL=0

# Если не работает - попробовать по шагам:
ACE_DISABLE_FEED_ASSIST INDEX=0  # Отключить текущий
ACE_RETRACT INDEX=0 LENGTH=100 SPEED=25  # Откатить
# Подождать...
ACE_PARK_TO_TOOLHEAD INDEX=1  # Парковать новый
```

### Симптом: Ошибка "Slot is not ready"

**Причины:**
- Слот пуст
- Филамент застрял
- Проблемы с механизмом ACE

**Решение:**
1. Проверьте физическое состояние слота
2. Убедитесь, что филамент правильно заправлен
3. Попробуйте другой слот
4. Проверьте статус: `ACE_STATUS`

---

## Проблемы с подачей/откатом

### Симптом: Филамент не подается

**Диагностика:**
```gcode
# Попробовать подачу
ACE_FEED INDEX=0 LENGTH=50 SPEED=25

# Проверить статус
ACE_STATUS
```

**Возможные причины:**

1. **Слот пуст**
   - Проверьте наличие филамента
   - Проверьте статус слота

2. **Филамент застрял**
   - Проверьте путь филамента
   - Освободите застрявший филамент вручную

3. **Неправильная скорость**
   ```ini
   # Попробуйте увеличить скорость
   feed_speed: 25
   ```

### Симптом: Медленная подача/откат

**Решение:**
```ini
# Увеличьте скорость в конфигурации
feed_speed: 25  # Максимум 25 для ACE Pro
retract_speed: 25
```

Или укажите скорость в команде:
```gcode
ACE_FEED INDEX=0 LENGTH=50 SPEED=25
```

### Симптом: Команды не выполняются

**Диагностика:**
```gcode
# Проверить статус устройства
ACE_STATUS

# Если disconnected - см. раздел "Устройство не подключается"
```

---

## Проблемы с сушкой

### Симптом: Сушка не запускается

**Проверка:**
```gcode
# Проверить статус
ACE_STATUS

# Попробовать запустить сушку
ACE_START_DRYING TEMP=50 DURATION=120
```

**Возможные причины:**

1. **Превышена максимальная температура**
   ```ini
   # Проверьте настройку
   max_dryer_temperature: 55
   ```

2. **Неправильные параметры**
   - Температура должна быть 20-55°C
   - Время должно быть 1-240 минут

### Симптом: Температура не достигается

**Возможные причины:**
- Проблемы с нагревателем ACE
- Недостаточная мощность
- Проблемы с вентиляцией

**Решение:**
- Проверьте физическое состояние устройства
- Убедитесь, что вентиляторы работают
- Попробуйте меньшую температуру

---

## Проблемы производительности

### Симптом: Медленная работа команд

**Решение:**

1. **Уменьшите таймауты:**
   ```ini
   response_timeout: 1.5  # Вместо 2.0
   read_timeout: 0.05     # Вместо 0.1
   write_timeout: 0.3     # Вместо 0.5
   ```

2. **Отключите логирование:**
   ```ini
   disable_logging: True
   ```

3. **Уменьшите размер очереди:**
   ```ini
   max_queue_size: 10  # Вместо 20
   ```

### Симптом: Высокая нагрузка на CPU

**Решение:**
- Отключите DEBUG логирование
- Уменьшите частоту проверок статуса
- Проверьте другие процессы на системе

---

## Диагностика подключения

### Шаг 1: Проверка устройства

```bash
# Проверить USB устройство
lsusb | grep -i anycubic

# Ожидаемый вывод:
# Bus 001 Device 003: ID 28e9:018a Anycubic ACE
```

### Шаг 2: Проверка порта

```bash
# Проверить наличие порта
ls -la /dev/serial/by-id/ | grep -i ace

# Должно быть:
# usb-ANYCUBIC_ACE_1-if00 -> ../../ttyACM0
```

### Шаг 3: Проверка доступа

```bash
# Проверить права доступа
ls -l /dev/ttyACM0

# Должно быть что-то вроде:
# crw-rw---- 1 root dialout 166, 0 Jan 1 12:00 /dev/ttyACM0
```

### Шаг 4: Тест подключения

```bash
# Попробовать открыть порт (замените на ваш порт)
python3 -c "import serial; s=serial.Serial('/dev/ttyACM0', 115200); print('OK'); s.close()"
```

Если ошибка - проверьте права доступа или занятость порта.

### Шаг 5: Проверка через Klipper

```gcode
# Проверить статус
ACE_STATUS

# Проверить информацию
ACE_DEBUG METHOD=get_info
```

---

## Типичные ошибки и решения

### Ошибка: "Connection lost"

**Причина:** Потеря связи с устройством

**Решение:**
1. Проверьте USB кабель
2. Перезапустите Klipper: `sudo systemctl restart klipper`
3. Проверьте логи на детали ошибки

### Ошибка: "Queue overflow"

**Причина:** Слишком много команд отправлено одновременно

**Решение:**
```ini
# Увеличьте размер очереди
max_queue_size: 30  # Вместо 20
```

Или уменьшите частоту отправки команд.

### Ошибка: "CRC mismatch"

**Причина:** Ошибка передачи данных

**Решение:**
1. Проверьте USB кабель (может быть поврежден)
2. Попробуйте другой USB порт
3. Уменьшите скорость обмена (не рекомендуется):
   ```ini
   baud: 57600  # Вместо 115200
   ```

### Ошибка: "Slot is not ready"

**Причина:** Слот пуст или филамент не готов

**Решение:**
1. Проверьте наличие филамента в слоте
2. Проверьте правильность заправки
3. Попробуйте другой слот
4. Проверьте статус: `ACE_STATUS`

---

## Сбор информации для отладки

Если проблема не решается, соберите следующую информацию:

### 1. Логи Klipper

```bash
# Последние 100 строк логов
tail -100 ~/printer_data/logs/klippy.log > klipper_log.txt
```

### 2. Статус устройства

```gcode
ACE_STATUS
```

Сохраните вывод.

### 3. Информация об устройстве

```gcode
ACE_DEBUG METHOD=get_info
```

### 4. Информация о системе

```bash
# Версия Klipper
cd ~/klipper && git log -1

# Версия Python
python3 --version

# USB устройства
lsusb > usb_devices.txt

# Последовательные порты
ls -la /dev/serial/by-id/ > serial_ports.txt
```

### 5. Конфигурация

```bash
# Скопируйте ace.cfg
cp ~/printer_data/config/ace.cfg ace_config_backup.txt
```

---

## Получение помощи

Если проблема не решается:

1. **Проверьте документацию:**
   - [Руководство пользователя](USER_GUIDE.md)
   - [Справочник команд](COMMANDS.md)
   - [Конфигурация](CONFIGURATION.md)

2. **Поиск в обсуждениях:**
   - [Telegram - perdoling3d](https://t.me/perdoling3d/45834)
   - [Telegram - ERCFcrealityACEpro](https://t.me/ERCFcrealityACEpro/21334)

3. **Создайте Issue на GitHub:**
   - Приложите собранную информацию
   - Опишите шаги воспроизведения
   - Укажите версию Klipper и модель принтера

---

*Дата последнего обновления: 2024*

