# Техническая спецификация ValgACE

## 1. Архитектурное описание системы

### 1.1. Общая архитектура

ValgACE представляет собой комплексное решение для интеграции Anycubic Color Engine Pro (ACE Pro) с экосистемой Klipper. Архитектура состоит из следующих основных компонентов:

- **Klipper модуль** (`extras/ace.py`) - основной драйвер, обеспечивающий связь с устройством ACE
- **Moonraker компонент** (`moonraker/ace_status.py`) - расширение API для REST и WebSocket доступа
- **Веб-интерфейс** (`web-interface/`) - пользовательский интерфейс для управления устройством
- **Дополнительные модули** - температурный сенсор, утилиты и т.д.

### 1.2. Компоненты их взаимодействие

#### 1.2.1. Klipper модуль (ValgAce)
- **Назначение**: Основной драйвер для управления устройством ACE
- **Функции**:
 - Установление и поддержание соединения с устройством по USB
  - Обработка G-code команд
  - Реализация протокола общения с ACE
  - Управление очередями команд
  - Обработка состояний и событий устройства

#### 1.2. Moonraker компонент (AceStatus)
- **Назначение**: Расширение Moonraker API для доступа к статусу ACE
- **Функции**:
 - Обеспечение REST API эндпоинтов
 - Поддержка WebSocket подписок на обновления
  - Кэширование статуса устройства
  - Выполнение команд через G-code

#### 1.2.3. Веб-интерфейс
- **Назначение**: Графический интерфейс для управления и мониторинга
- **Функции**:
 - Отображение статуса устройства в реальном времени
  - Управление слотами филамента
  - Управление сушкой
  - Ручное управление подачей/откатом филамента

### 1.3. Структура проекта
```
ValgACE/
├── extras/                 # Klipper модули
│   ├── ace.py             # Основной драйвер
│   └── temperature_ace.py # Температурный сенсор
├── moonraker/             # Moonraker компоненты
│   └── ace_status.py      # API расширение
├── web-interface/         # Веб-интерфейс
│   ├── ace-dashboard.html # Основная страница
│   ├── ace-dashboard.js   # Логика
│   └── ace-dashboard.css  # Стили
├── docs/                  # Документация
├── ace.cfg               # Конфигурация
├── ace.cfg.sample        # Пример конфигурации
└── install.sh            # Скрипт установки
```

## 2. Протокол общения с устройством ACE

### 2.1. Транспортный уровень
- **Интерфейс**: USB CDC (USB Communication Device Class)
- **Скорость передачи**: 115200 бод (настраиваемая)
- **Контроль потока**: отсутствует
- **Проверка целостности данных**: отсутствует

### 2.2. Фрейминг
Каждая JSON команда упаковывается в фрейм следующего формата:

- **Заголовок**: 2 байта `0xFF 0xAA`
- **Длина полезной нагрузки**: 2 байта (little endian)
- **JSON полезная нагрузка**: строка JSON
- **CRC**: 2 байта (CRC-16/MCRF4XX, little endian)
- **Терминатор**: 1 байт `0xFE`

### 2.3. RPC-протокол
Каждый запрос к ACE Pro содержит следующие JSON данные:
- `id`: Номер сообщения (уникальный идентификатор запроса)
- `method`: Строка, идентифицирующая метод
- `params`: Словарь параметров, специфичных для метода (опционально)

Каждый ответ от ACE содержит следующие JSON данные:
- `id`: Номер сообщения запроса
- `result`: Словарь возвращаемых данных, специфичных для метода
- `code`: Код возврата, специфичный для метода
- `msg`: Сообщение, специфичное для метода

### 2.4. Поддерживаемые методы

#### 2.4.1. Управление RFID
- **`enable_rfid`**
  - Запрос: без параметров
  - Ответ: `{"msg": "success", "code": 0}`

- **`disable_rfid`**
  - Запрос: без параметров
  - Ответ: `{"msg": "success", "code": 0}`

#### 2.4.2. Получение информации
- **`get_info`**
 - Запрос: без параметров
  - Ответ: 
    ```json
    {
      "id": 0,
      "slots": 4,
      "model": "Anycubic Color Engine Pro",
      "firmware": "V1.3.82",
      "boot_firmware": "V1.0.1"
    }
    ```

- **`get_filament_info`**
 - Запрос: `{"index": <номер слота>}`
  - Ответ:
    ```json
    {
      "index": <номер слота>,
      "sku": "ABCDEF-01",
      "brand": "FakeBrand",
      "type": "PLA",
      "color": [255, 0, 0],
      "rfid": 2,
      "extruder_temp": {"min": 180, "max": 240},
      "hotbed_temp": {"min": 0, "max": 80},
      "diameter": 1.75,
      "total": 330,
      "current": 0
    }
    ```

#### 2.4.3. Управление статусом
- **`get_status`**
  - Запрос: без параметров
  - Ответ:
    ```json
    {
      "status": "ready",
      "action": "feeding",
      "dryer_status": {
        "status": "stop",
        "target_temp": 60,
        "duration": 300,
        "remain_time": 50
      },
      "temp": 25,
      "enable_rfid": 1,
      "fan_speed": 700,
      "feed_assist_count": 0,
      "cont_assist_time": 0.0,
      "slots": [...]
    }
    ```

#### 2.4.4. Управление сушкой
- **`drying`**
  - Запрос: `{"temp": <температура>, "fan_speed": 7000, "duration": <длительность>}`
  - Ответ: `{"msg": "drying", "code": 0}`

- **`drying_stop`**
  - Запрос: без параметров
  - Ответ: `{"msg": "success", "code": 0}`

#### 2.4.5. Управление филаментом
- **`feed_filament`**
  - Запрос: `{"index": <слот>, "length": <длина>, "speed": <скорость>}`
  - Ответ: `{"msg": "success", "code": 0}`

- **`unwind_filament`**
  - Запрос: `{"index": <слот>, "length": <длина>, "speed": <скорость>, "mode": <режим>}`
  - Ответ: `{"msg": "success", "code": 0}`

- **`start_feed_assist`**
 - Запрос: `{"index": <слот>}`
  - Ответ: `{"msg": "success", "code": 0}`

- **`stop_feed_assist`**
  - Запрос: `{"index": <слот>}`
  - Ответ: `{"msg": "", "code": 0}`

## 3. Описание всех G-code команд и их параметров

### 3.1. Команды статуса
- **`ACE_STATUS`** - Получить полный статус устройства
 - Параметры: нет
  - Выводит информацию о состоянии устройства, сушилке, слотах и параметрах

- **`ACE_DEBUG METHOD=<метод> PARAMS=<параметры>`** - Отладочная команда
  - `METHOD`: Метод RPC (например, `get_info`, `get_status`)
  - `PARAMS`: JSON строка параметров (опционально)

- **`ACE_FILAMENT_INFO INDEX=<0-3>`** - Получить информацию о филаменте
 - `INDEX`: Номер слота (0-3)

### 3.2. Управление сушкой
- **`ACE_START_DRYING TEMP=<температура> DURATION=<длительность>`**
  - `TEMP`: Температура сушки (20-55°C)
  - `DURATION`: Длительность в минутах (по умолчанию 240)

- **`ACE_STOP_DRYING`** - Остановить сушку

### 3.3. Управление feed assist
- **`ACE_ENABLE_FEED_ASSIST INDEX=<0-3>`** - Включить feed assist
  - `INDEX`: Номер слота (0-3)

- **`ACE_DISABLE_FEED_ASSIST INDEX=<0-3>`** - Выключить feed assist
  - `INDEX`: Номер слота (0-3)

### 3.4. Управление филаментом
- **`ACE_FEED INDEX=<0-3> LENGTH=<длина> SPEED=<скорость>`**
  - `INDEX`: Номер слота (0-3)
  - `LENGTH`: Длина подачи в мм (обязательно)
  - `SPEED`: Скорость подачи в мм/с (по умолчанию 50)

- **`ACE_RETRACT INDEX=<0-3> LENGTH=<длина> SPEED=<скорость> MODE=<0|1>`**
  - `INDEX`: Номер слота (0-3)
  - `LENGTH`: Длина отката в мм (обязательно)
  - `SPEED`: Скорость отката в мм/с (по умолчанию 50)
  - `MODE`: Режим (0 - обычный, 1 - улучшенный)

- **`ACE_UPDATE_FEEDING_SPEED INDEX=<0-3> SPEED=<скорость>`** - Обновить скорость подачи
- **`ACE_UPDATE_RETRACT_SPEED INDEX=<0-3> SPEED=<скорость>`** - Обновить скорость отката
- **`ACE_STOP_FEED INDEX=<0-3>`** - Остановить подачу
- **`ACE_STOP_RETRACT INDEX=<0-3>`** - Остановить откат

### 3.5. Управление инструментом
- **`ACE_CHANGE_TOOL TOOL=<-1 to 3>`** - Смена инструмента
  - `TOOL`: Номер слота (0-3) или -1 для разгрузки

- **`ACE_PARK_TO_TOOLHEAD INDEX=<0-3>`** - Парковка филамента к хотэнду
  - `INDEX`: Номер слота (0-3)

### 3.6. Управление infinity spool
- **`ACE_INFINITY_SPOOL`** - Сменить инструмент при пустом слоте
- **`ACE_SET_INFINITY_SPOOL_ORDER ORDER="<0,1,2,3>"`** - Установить порядок слотов
 - `ORDER`: Строка с порядком слотов (например, "0,1,none,3")

### 3.7. Алиасы команд
- **`T0`, `T1`, `T2`, `T3`** - Быстрая смена инструмента (эквивалент `ACE_CHANGE_TOOL`)
- **`TR`** - Разгрузка филамента (эквивалент `ACE_CHANGE_TOOL TOOL=-1`)

## 4. Структура данных статуса устройства

### 4.1. Основная структура
```json
{
 "status": "ready",
  "model": "Anycubic Color Engine Pro",
  "firmware": "V1.3.82",
  "boot_firmware": "V1.0.1",
  "temp": 25,
  "fan_speed": 700,
  "enable_rfid": 1,
  "feed_assist_count": 0,
  "cont_assist_time": 0.0,
  "feed_assist_slot": -1,
  "dryer": {
    "status": "stop",
    "target_temp": 0,
    "duration": 0,
    "remain_time": 0
  },
  "slots": [
    {
      "index": 0,
      "status": "ready",
      "sku": "PLA-RED-01",
      "type": "PLA",
      "color": [255, 0, 0],
      "rfid": 2
    },
    ...
  ]
}
```

### 4.2. Описание полей
- **`status`**: Состояние устройства (`ready`, `busy`, `disconnected`, `unknown`)
- **`model`**: Модель устройства
- **`firmware`**: Версия прошивки
- **`boot_firmware`**: Версия загрузчика
- **`temp`**: Температура в градусах Цельсия
- **`fan_speed`**: Скорость вентилятора в RPM
- **`enable_rfid`**: Статус RFID (0 - выключен, 1 - включен)
- **`feed_assist_count`**: Счетчик feed assist
- **`cont_assist_time`**: Время непрерывной подачи в мс
- **`feed_assist_slot`**: Индекс слота с активным feed assist (-1 если выключен)
- **`dryer`**: Информация о сушилке
- **`slots`**: Массив информации о слотах

### 4.3. Статусы слотов
- **`index`**: Номер слота (0-3)
- **`status`**: Статус слота (`ready`, `empty`, `unknown`)
- **`sku`**: Артикул филамента
- **`type`**: Тип филамента (PLA, PETG, ABS и т.д.)
- **`color`**: Цвет в формате RGB [R, G, B]
- **`rfid`**: Статус RFID (0 - не найден, 1 - ошибка, 2 - идентифицирован, 3 - идентификация)

## 5. Процесс интеграции с Klipper и Moonraker

### 5.1. Интеграция с Klipper
1. **Установка модуля**:
   - Создается символическая ссылка `~/klipper/klippy/extras/ace.py` → `~/ValgACE/extras/ace.py`
   - Модуль автоматически загружается Klipper при старте

2. **Конфигурация**:
   - Добавляется секция `[ace]` в конфигурационный файл Klipper
   - Настройка параметров подключения и работы

3. **Регистрация команд**:
   - Все G-code команды автоматически регистрируются в Klipper
   - Команды доступны через интерфейсы (Mainsail, Fluidd и т.д.)

### 5.2. Интеграция с Moonraker
1. **Установка компонента**:
   - Создается символическая ссылка `~/moonraker/moonraker/components/ace_status.py` → `~/ValgACE/moonraker/ace_status.py`
   - Компонент автоматически загружается Moonraker при старте

2. **Регистрация API эндпоинтов**:
   - `/server/ace/status` - GET запрос статуса
   - `/server/ace/slots` - GET информация о слотах
   - `/server/ace/command` - POST выполнение команд

3. **WebSocket подписка**:
   - Событие `ace:status_update` для получения обновлений статуса в реальном времени

### 5.3. Конфигурация Moonraker
- Автоматически добавляется секция `[ace_status]` в `moonraker.conf`
- Регистрация обновлений через `update_manager`:
  ```ini
 [update_manager ValgACE]
  type: git_repo
  path: ~/ValgACE
  origin: https://github.com/agrloki/ValgACE.git
 primary_branch: main
  managed_services: klipper
  ```

## 6. Рекомендации по разработке и отладке

### 6.1. Рекомендации по разработке
1. **Использование асинхронных операций**:
   - Использовать `reactor` для таймеров и задержек
   - Не блокировать основной поток выполнения
   - Использовать асинхронные методы вместо синхронных пауз

2. **Обработка ошибок**:
   - Обязательная обработка исключений в callback-функциях
   - Логирование ошибок для диагностики
   - Обработка состояний подключения и отключения

3. **Управление очередями**:
   - Использовать очереди для обеспечения порядка команд
   - Ограничение размера очереди для предотвращения переполнения
   - Обработка переполнения очереди

4. **Тестирование**:
   - Тестирование на реальном оборудовании
   - Использование отладочных команд для проверки функциональности
   - Проверка граничных условий и ошибочных ситуаций

### 6.2. Рекомендации по отладке
1. **Логирование**:
   - Использование `self.logger` для отладочной информации
   - Логирование всех команд и ответов
   - Логирование состояний устройства

2. **Отладочные команды**:
   - `ACE_DEBUG METHOD=get_info` - проверка соединения
   - `ACE_DEBUG METHOD=get_status` - проверка статуса
   - `ACE_STATUS` - получение полного статуса

3. **Проверка соединения**:
   - Проверка логов Klipper: `tail -f ~/printer_data/logs/klippy.log | grep -i ace`
   - Проверка логов Moonraker: `tail -f ~/printer_data/logs/moonraker.log | grep -i ace`

4. **Тестирование протокола**:
   - Использование `ACE_DEBUG` для прямого взаимодействия с устройством
   - Проверка формата сообщений и CRC

### 6.3. Безопасность
1. **Таймауты**:
   - Установка разумных таймаутов для всех операций
   - Проверка состояния устройства перед выполнением команд

2. **Валидация параметров**:
   - Проверка диапазонов значений
   - Проверка корректности типов данных

3. **Обработка состояний**:
   - Проверка статуса устройства перед выполнением команд
   - Обработка ошибок и сбоев корректно

## 7. Возможные направления развития проекта

### 7.1. Улучшения протокола
1. **Расширение командного набора**:
   - Добавление новых методов для более точного управления
   - Поддержка дополнительных функций устройства
   - Улучшение обработки ошибок

2. **Оптимизация производительности**:
   - Улучшение алгоритмов обработки сообщений
   - Оптимизация очередей и буферов
   - Снижение задержек при обмене данными

### 7.2. Улучшения интерфейса
1. **Расширение веб-интерфейса**:
   - Добавление новых визуализаций и диаграмм
   - Улучшение UX/UI для более удобного управления
   - Поддержка мобильных устройств

2. **Интеграция с другими интерфейсами**:
   - Поддержка дополнительных веб-интерфейсов (Mainsail, Fluidd)
   - Интеграция с KlipperScreen
   - Поддержка API для сторонних приложений

### 7.3. Улучшения функциональности
1. **Улучшение системы сушки**:
   - Расширенное управление параметрами сушки
   - Поддержка профилей сушки для разных материалов
   - Автоматическое управление в зависимости от типа филамента

2. **Улучшение системы слотов**:
   - Поддержка большего количества слотов
   - Улучшенное управление RFID-информацией
   - Поддержка профилей филаментов

3. **Улучшение системы инструментов**:
   - Расширенная поддержка infinity spool
   - Автоматическое определение пустых слотов
   - Улучшенное управление сменой инструментов

### 7.4. Улучшения интеграции
1. **Расширение API**:
   - Добавление новых эндпоинтов Moonraker API
   - Поддержка более сложных сценариев через API
   - Улучшенная документация API

2. **Поддержка других устройств**:
   - Возможность адаптации для других MMU устройств
   - Создание унифицированного интерфейса для разных MMU
   - Поддержка плагинов для разных производителей

### 7.5. Документация и сообщество
1. **Расширение документации**:
   - Добавление примеров использования
   - Создание руководств по устранению неполадок
   - Поддержка нескольких языков

2. **Улучшение инструментов разработки**:
   - Создание тестовых сред
   - Инструменты для симуляции устройства
   - Автоматизированные тесты