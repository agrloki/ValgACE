# Руководство по конфигурации ValgACE

Подробное описание всех параметров конфигурации модуля ValgACE.

## Содержание

1. [Основная конфигурация](#основная-конфигурация)
2. [Параметры подключения](#параметры-подключения)
3. [Параметры таймаутов](#параметры-таймаутов)
4. [Параметры работы](#параметры-работы)
5. [Параметры логирования](#параметры-логирования)
6. [Макросы G-code](#макросы-g-code)
7. [Примеры конфигураций](#примеры-конфигураций)

---

## Основная конфигурация

### Секция `[ace]`

Все параметры модуля ValgACE задаются в секции `[ace]` файла `ace.cfg`.

**Важно:** В файле `ace.cfg.sample` содержатся примеры конфигурации и готовые макросы G-code, которые можно использовать в качестве основы для вашей конфигурации. Рекомендуется начать с копирования `ace.cfg.sample` в `ace.cfg` и адаптации под ваш принтер.

**Минимальная конфигурация:**
```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200
```

---

## Параметры подключения

### `serial`

Путь к последовательному порту устройства ACE.

**Тип:** строка  
**По умолчанию:** Автопоиск по VID/PID или `/dev/ttyACM0`

**Примеры:**
```ini
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
serial: /dev/ttyACM0
serial: /dev/ttyUSB0
```

**Рекомендации:**
- Используйте `/dev/serial/by-id/` для стабильности (не меняется при переподключении)
- Модуль автоматически определяет устройство по VID/PID `0x28e9:0x018a`
- Можно не указывать, если устройство определяется автоматически

**Автопоиск:**
Модуль автоматически ищет устройство по:
- VID/PID: `0x28e9:0x018a`
- Описанию порта: "ACE", "BunnyAce", "DuckAce"

---

### `baud`

Скорость обмена данными с устройством.

**Тип:** целое число  
**По умолчанию:** `115200`

**Возможные значения:**
- `115200` (рекомендуется, стандарт для ACE Pro)

**Пример:**
```ini
baud: 115200
```

**Примечание:** Изменение скорости не рекомендуется, если не требуется для совместимости.

---

## Параметры таймаутов

### `response_timeout`

Таймаут ожидания ответа от устройства (в секундах).

**Тип:** число с плавающей точкой  
**По умолчанию:** `2.0`

**Пример:**
```ini
response_timeout: 2.0
```

**Рекомендации:**
- Не рекомендуется уменьшать ниже 1.0 секунды
- Увеличение может привести к медленной реакции на ошибки

---

### `read_timeout`

Таймаут чтения данных из порта (в секундах).

**Тип:** число с плавающей точкой  
**По умолчанию:** `0.1`

**Пример:**
```ini
read_timeout: 0.1
```

---

### `write_timeout`

Таймаут записи данных в порт (в секундах).

**Тип:** число с плавающей точкой  
**По умолчанию:** `0.5`

**Пример:**
```ini
write_timeout: 0.5
```

---

### `max_queue_size`

Максимальный размер очереди команд.

**Тип:** целое число  
**По умолчанию:** `20`

**Пример:**
```ini
max_queue_size: 20
```

**Примечание:** При переполнении очереди старые команды удаляются с ошибкой "Queue overflow".

---

## Параметры работы

### `feed_speed`

Скорость подачи филамента по умолчанию (мм/с).

**Тип:** целое число  
**По умолчанию:** `50` (в коде), `25` (в конфиге)

**Диапазон:** 10-25 (рекомендуется производителем)

**Пример:**
```ini
feed_speed: 25
```

**Примечание:** Значение по умолчанию в коде (`50`) и конфиге (`25`) различаются. Рекомендуется использовать значение из конфига.

---

### `retract_speed`

Скорость отката филамента по умолчанию (мм/с).

**Тип:** целое число  
**По умолчанию:** `50` (в коде), `25` (в конфиге)

**Диапазон:** 10-25 (рекомендуется производителем)

**Пример:**
```ini
retract_speed: 25
```

---

### `retract_mode`

Режим отката филамента.

**Тип:** целое число  
**По умолчанию:** `0`

**Возможные значения:**
- `0` - Обычный режим (normal mode)
- `1` - Улучшенный режим (enhanced mode)

**Пример:**
```ini
retract_mode: 0
```

**Примечание:** Улучшенный режим может быть более надежным для некоторых типов филамента.

---

### `toolchange_retract_length`

Длина отката филамента при смене инструмента (мм).

**Тип:** целое число  
**По умолчанию:** `100`

**Пример:**
```ini
toolchange_retract_length: 100
```

**Примечание:** Увеличение значения может помочь при проблемах с остатками филамента в хотенде.

---

### `park_hit_count`

Количество стабильных проверок для завершения парковки.

**Тип:** целое число  
**По умолчанию:** `5`

**Пример:**
```ini
park_hit_count: 5
```

**Как работает:**
- При парковке модуль отслеживает счетчик `feed_assist_count`
- Когда счетчик не изменяется `park_hit_count` раз подряд, парковка считается завершенной
- Меньшее значение = быстрее завершение (но менее надежно)
- Большее значение = более надежно (но медленнее)

**Рекомендации:**
- Начните с значения по умолчанию (5)
- Если парковка завершается слишком быстро → увеличьте значение
- Если парковка не завершается → уменьшите значение (но не менее 3)

---

### `max_dryer_temperature`

Максимальная температура сушилки (°C).

**Тип:** целое число  
**По умолчанию:** `55`

**Пример:**
```ini
max_dryer_temperature: 55
```

**Примечание:** 
- Значение выше 60°C не тестировалось и может быть небезопасным
- Используется для ограничения параметра `TEMP` в команде `ACE_START_DRYING`

---

### `disable_assist_after_toolchange`

Отключать ли feed assist после смены инструмента.

**Тип:** булево значение  
**По умолчанию:** `True`

**Пример:**
```ini
disable_assist_after_toolchange: True
```

**Примечание:**
- Если `True` - assist автоматически отключается после смены инструмента
- Если `False` - assist остается включенным

---

### `infinity_spool_mode`

Режим бесконечной катушки (автоматическая смена при окончании филамента).

**Тип:** булево значение  
**По умолчанию:** `False`

**Пример:**
```ini
infinity_spool_mode: True
```

**Требования:**
- Порядок слотов должен быть установлен через `ACE_SET_INFINITY_SPOOL_ORDER`
- Минимум один слот в порядке должен быть готов (`ready`)

**Использование:**
1. Включите режим в конфигурации: `infinity_spool_mode: True`
2. Установите порядок слотов: `ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"`
3. Используйте `ACE_INFINITY_SPOOL` при окончании филамента

**Переменные:**
- `ace_infsp_order` - порядок слотов (строка, например: `"0,1,none,3"`)
- `ace_infsp_position` - текущая позиция в порядке (0-3)

**Сброс позиции:**
```gcode
RESET_INFINITY_SPOOL
```

---

## Параметры логирования

### `disable_logging`

Отключить логирование событий.

**Тип:** булево значение  
**По умолчанию:** `False` (логирование включено)

**Пример:**
```ini
# Отключить логирование
disable_logging: True
```

---

### `log_dir`

Директория для логов.

**Тип:** строка (путь)  
**По умолчанию:** `~/printer_data/logs`

**Пример:**
```ini
log_dir: ~/printer_data/logs
```

---

### `log_level`

Уровень детализации логирования.

**Тип:** строка  
**По умолчанию:** `INFO`

**Возможные значения:**
- `DEBUG` - Максимальная детализация (включая обмен данными)
- `INFO` - Основные события и команды
- `WARNING` - Только предупреждения и ошибки
- `ERROR` - Только критические ошибки

**Пример:**
```ini
log_level: DEBUG
```

**Рекомендации:**
- `DEBUG` - для отладки проблем
- `INFO` - для обычной работы
- `WARNING` / `ERROR` - для минимизации логов

---

### `max_log_size`

Максимальный размер одного лог-файла (МБ).

**Тип:** целое число  
**По умолчанию:** `10`

**Пример:**
```ini
max_log_size: 10
```

---

### `log_backup_count`

Количество ротируемых лог-файлов.

**Тип:** целое число  
**По умолчанию:** `3`

**Пример:**
```ini
log_backup_count: 3
```

**Примечание:** При достижении `max_log_size` создается новый файл, старые файлы сохраняются до `log_backup_count`.

---

## Макросы G-code

### Обязательные макросы

Эти макросы должны быть определены в `ace.cfg`:

#### `_ACE_PRE_TOOLCHANGE`

Выполняется перед сменой инструмента.

**Параметры:**
- `FROM` - Индекс предыдущего инструмента (-1 если не было)
- `TO` - Индекс нового инструмента

**Пример настройки:**
```gcode
[gcode_macro _ACE_PRE_TOOLCHANGE]
gcode:
    # Нагрев экструдера до рабочей температуры
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=220
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=220
    
    # Сохранение состояния
    SAVE_GCODE_STATE NAME=FILAMENT_CHANGE_STATE
    
    # Отключение assist для предыдущего слота
    {% if params.FROM is defined and params.FROM|int != -1 %}
        ACE_DISABLE_FEED_ASSIST INDEX={params.FROM|int}
    {% endif %}
    
    # Перемещение в зону очистки
    G1 X-8 Y0 F7800
```

#### `_ACE_POST_TOOLCHANGE`

Выполняется после смены инструмента.

**Параметры:**
- `FROM` - Индекс предыдущего инструмента
- `TO` - Индекс нового инструмента

**Пример настройки:**
```gcode
[gcode_macro _ACE_POST_TOOLCHANGE]
gcode:
    # Подача филамента для очистки
    {% if params.TO is defined and params.TO|int != -1 %}
        G91
        G1 E100 F300
        G90
    {% endif %}
    
    # Включение assist для нового слота
    {% if params.TO is defined and params.TO|int != -1 %}
        ACE_ENABLE_FEED_ASSIST INDEX={params.TO|int}
    {% endif %}
    
    # Восстановление состояния
    RESTORE_GCODE_STATE NAME=FILAMENT_CHANGE_STATE MOVE=1 MOVE_SPEED=1500
```

#### `_ACE_ON_EMPTY_ERROR`

Выполняется при обнаружении пустого слота.

**Параметры:**
- `INDEX` - Индекс пустого слота

**Пример:**
```gcode
[gcode_macro _ACE_ON_EMPTY_ERROR]
gcode:
    {action_respond_info("Spool is empty")}
    {% if printer.idle_timeout.state == "Printing" %}
        PAUSE
    {% endif %}
```

### Опциональные макросы

Для режима infinity spool:

#### `_ACE_PRE_INFINITYSPOOL`

Выполняется перед сменой катушки в режиме infinity spool.

**Параметры:** Нет

**Использование:** Настраивается в `ace.cfg` под вашу конфигурацию принтера.

#### `_ACE_POST_INFINITYSPOOL`

Выполняется после смены катушки в режиме infinity spool.

**Параметры:** Нет

**Использование:** Настраивается в `ace.cfg` под вашу конфигурацию принтера.

#### `SET_INFINITY_SPOOL_ORDER`

Удобный макрос для установки порядка слотов infinity spool.

**Параметры:**
- `ORDER` - порядок слотов в формате `"0,1,2,3"` или `"0,1,none,3"`

**Пример:**
```gcode
[gcode_macro SET_INFINITY_SPOOL_ORDER]
gcode:
    {% if params.ORDER is defined %}
        ACE_SET_INFINITY_SPOOL_ORDER ORDER={params.ORDER}
    {% else %}
        RESPOND TYPE=error MSG="ORDER parameter required"
    {% endif %}
```

#### `RESET_INFINITY_SPOOL`

Сброс позиции в порядке infinity spool.

**Пример:**
```gcode
[gcode_macro RESET_INFINITY_SPOOL]
gcode:
    SAVE_VARIABLE VARIABLE=ace_infsp_position VALUE=0
```

---

## Примеры конфигураций

### Минимальная конфигурация

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200
```

---

### Стандартная конфигурация

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200

# Параметры работы
feed_speed: 25
retract_speed: 25
retract_mode: 0
toolchange_retract_length: 100
park_hit_count: 5
max_dryer_temperature: 55
disable_assist_after_toolchange: True
infinity_spool_mode: False

# Очередь команд
max_queue_size: 20
```

---

### Конфигурация для отладки

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200

# Логирование
log_level: DEBUG
max_log_size: 20
log_backup_count: 5

# Таймауты
response_timeout: 3.0
read_timeout: 0.2
write_timeout: 1.0

# Параметры работы
feed_speed: 25
retract_speed: 25
park_hit_count: 3  # Меньше для быстрой отладки
```

---

### Конфигурация с infinity spool

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200

# Включить режим бесконечной катушки
infinity_spool_mode: True

# Параметры работы
feed_speed: 25
retract_speed: 25
toolchange_retract_length: 100
park_hit_count: 5
disable_assist_after_toolchange: True
```

**После настройки конфигурации установите порядок слотов:**
```gcode
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"
# Или с пропуском пустых слотов:
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"
```

---

### Оптимизированная конфигурация для быстрой работы

```ini
[ace]
serial: /dev/serial/by-id/usb-ANYCUBIC_ACE_1-if00
baud: 115200

# Быстрые таймауты
response_timeout: 1.5
read_timeout: 0.05
write_timeout: 0.3

# Оптимизированная парковка
park_hit_count: 3  # Быстрее завершение

# Отключение логирования для производительности
disable_logging: True
```

---

## Рекомендации по настройке

### Для разных типов принтеров

**Creality K1 / K1 Max:**
- Используйте стандартную конфигурацию
- Значения по умолчанию работают хорошо

**Другие принтеры:**
- Начните со стандартной конфигурации
- При необходимости увеличьте `park_hit_count` если парковка нестабильна
- Уменьшите `park_hit_count` если парковка слишком медленная

### Для разных типов филамента

**PLA:**
- Стандартные значения работают хорошо
- `retract_mode: 0` обычно достаточно

**TPU / Flex:**
- Может потребоваться `retract_mode: 1` (enhanced mode)
- Уменьшите скорости подачи/отката

**ABS / PETG:**
- Стандартные значения обычно подходят
- Может потребоваться увеличение `toolchange_retract_length`

---

## Проверка конфигурации

После изменения конфигурации:

1. **Проверьте синтаксис:**
```bash
python3 -m py_compile ~/printer_data/config/ace.cfg
```

2. **Перезапустите Klipper:**
```bash
sudo systemctl restart klipper
```

3. **Проверьте логи:**
```bash
tail -f ~/printer_data/logs/klippy.log | grep -i ace
```

4. **Проверьте подключение:**
```gcode
ACE_STATUS
ACE_DEBUG METHOD=get_info
```

---

*Дата последнего обновления: 2024*

