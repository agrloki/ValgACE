# Справочник команд ValgACE

Полный список всех доступных команд G-code для управления устройством Anycubic Color Engine Pro.

## Содержание

1. [Информационные команды](#информационные-команды)
2. [Управление инструментом](#управление-инструментом)
3. [Управление филаментом](#управление-филаментом)
4. [Управление сушкой](#управление-сушкой)
5. [Отладочные команды](#отладочные-команды)
6. [Алиасы команд](#алиасы-команд)

---

## Информационные команды

### `ACE_STATUS`

Получить полный статус устройства ACE.

**Синтаксис:**
```gcode
ACE_STATUS
```

**Возвращает:**
- Статус устройства (`ready`, `busy`, `disconnected`)
- Статус сушилки
- Температура сушилки
- Информация о всех слотах (0-3)
- Текущий счетчик feed assist

**Пример:**
```gcode
ACE_STATUS
```

**Ответ:**
```json
{
  "status": "ready",
  "temp": 25,
  "dryer": {
    "status": "stop",
    "target_temp": 0,
    "duration": 0,
    "remain_time": 0
  },
  "slots": [
    {
      "index": 0,
      "status": "ready",
      "type": "PLA",
      "color": [255, 0, 0]
    },
    ...
  ]
}
```

---

### `ACE_FILAMENT_INFO`

Получить информацию о филаменте в указанном слоте (требует RFID метки).

**Синтаксис:**
```gcode
ACE_FILAMENT_INFO INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Возвращает:**
- Информацию о филаменте из RFID метки:
  - `sku` - Артикул
  - `brand` - Бренд
  - `type` - Тип материала (PLA, ABS, PETG и т.д.)
  - `color` - Цвет [R, G, B]
  - `diameter` - Диаметр (обычно 1.75)
  - `extruder_temp` - Температура экструдера (min/max)
  - `hotbed_temp` - Температура стола (min/max)
  - `total` - Общий объем (м)
  - `current` - Текущий объем (м)

**Пример:**
```gcode
ACE_FILAMENT_INFO INDEX=0
```

**Примечание:** Команда работает только для филаментов с RFID метками. Для обычных филаментов информация может быть недоступна.

---

## Управление инструментом

### `ACE_CHANGE_TOOL`

Смена инструмента (автоматическая загрузка/выгрузка филамента).

**Синтаксис:**
```gcode
ACE_CHANGE_TOOL TOOL=<инструмент>
```

**Параметры:**
- `TOOL` (обязательный) - Номер инструмента:
  - `-1` - Выгрузить филамент из хотенда
  - `0-3` - Загрузить филамент из соответствующего слота

**Процесс выполнения:**
1. Проверка текущего инструмента
2. Выполнение макроса `_ACE_PRE_TOOLCHANGE`
3. Откат текущего филамента (если был загружен)
4. Ожидание готовности слота после отката
5. Парковка нового филамента к соплу
6. Выполнение макроса `_ACE_POST_TOOLCHANGE`

**Примеры:**
```gcode
ACE_CHANGE_TOOL TOOL=0     # Загрузить слот 0
ACE_CHANGE_TOOL TOOL=2     # Загрузить слот 2
ACE_CHANGE_TOOL TOOL=-1    # Выгрузить текущий филамент
```

**Примечания:**
- Команда автоматически проверяет готовность слота
- Если слот пуст, вызывается макрос `_ACE_ON_EMPTY_ERROR`
- Процесс полностью асинхронный и не блокирует печать

---

### `ACE_PARK_TO_TOOLHEAD`

Припарковать филамент из указанного слота к соплу принтера.

**Синтаксис:**
```gcode
ACE_PARK_TO_TOOLHEAD INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Процесс:**
1. Проверка готовности слота
2. Запуск feed assist для слота
3. Мониторинг счетчика `feed_assist_count`
4. Определение завершения парковки по стабилизации счетчика
5. Автоматическая остановка feed assist

**Пример:**
```gcode
ACE_PARK_TO_TOOLHEAD INDEX=0
```

**Как работает парковка:**
- Филамент подается из ACE к соплу
- При достижении сопла счетчик `feed_assist_count` увеличивается
- Когда счетчик стабилизируется (не изменяется N раз подряд), парковка считается завершенной
- Количество проверок настраивается через `park_hit_count` (по умолчанию 5)

**Примечания:**
- Одновременно может выполняться только одна парковка
- Если слот пуст, вызывается `_ACE_ON_EMPTY_ERROR`
- Процесс автоматически обрабатывает ошибки

---

## Управление филаментом

### `ACE_FEED`

Подать филамент из указанного слота.

**Синтаксис:**
```gcode
ACE_FEED INDEX=<0-3> LENGTH=<длина> SPEED=<скорость>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)
- `LENGTH` (обязательный) - Длина подачи в миллиметрах (минимум 1)
- `SPEED` (опциональный) - Скорость подачи в мм/с (по умолчанию из конфигурации)

**Примеры:**
```gcode
ACE_FEED INDEX=0 LENGTH=50 SPEED=25
ACE_FEED INDEX=2 LENGTH=100        # Использует скорость по умолчанию
```

**Примечания:**
- Рекомендуемая скорость: 10-25 мм/с (в зависимости от устройства)
- Команда асинхронная, не блокирует выполнение других команд

---

### `ACE_RETRACT`

Откатить филамент обратно в слот.

**Синтаксис:**
```gcode
ACE_RETRACT INDEX=<0-3> LENGTH=<длина> SPEED=<скорость> MODE=<режим>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)
- `LENGTH` (обязательный) - Длина отката в миллиметрах (минимум 1)
- `SPEED` (опциональный) - Скорость отката в мм/с (по умолчанию из конфигурации)
- `MODE` (опциональный) - Режим отката:
  - `0` - Обычный режим (по умолчанию)
  - `1` - Улучшенный режим

**Примеры:**
```gcode
ACE_RETRACT INDEX=0 LENGTH=50 SPEED=25
ACE_RETRACT INDEX=2 LENGTH=100 MODE=1
```

---

### `ACE_STOP_FEED`

Остановить подачу филамента.

**Синтаксис:**
```gcode
ACE_STOP_FEED INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Пример:**
```gcode
ACE_STOP_FEED INDEX=0
```

---

### `ACE_STOP_RETRACT`

Остановить откат филамента.

**Синтаксис:**
```gcode
ACE_STOP_RETRACT INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Пример:**
```gcode
ACE_STOP_RETRACT INDEX=0
```

---

### `ACE_UPDATE_FEEDING_SPEED`

Изменить скорость подачи на лету (во время выполнения операции).

**Синтаксис:**
```gcode
ACE_UPDATE_FEEDING_SPEED INDEX=<0-3> SPEED=<скорость>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)
- `SPEED` (обязательный) - Новая скорость подачи в мм/с (минимум 1)

**Пример:**
```gcode
ACE_UPDATE_FEEDING_SPEED INDEX=0 SPEED=30
```

**Применение:**
- Изменение скорости подачи во время печати
- Адаптация под разные типы филамента
- Оптимизация процесса загрузки

---

### `ACE_UPDATE_RETRACT_SPEED`

Изменить скорость отката на лету.

**Синтаксис:**
```gcode
ACE_UPDATE_RETRACT_SPEED INDEX=<0-3> SPEED=<скорость>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)
- `SPEED` (обязательный) - Новая скорость отката в мм/с (минимум 1)

**Пример:**
```gcode
ACE_UPDATE_RETRACT_SPEED INDEX=0 SPEED=20
```

---

## Feed Assist (Ассистент подачи)

### `ACE_ENABLE_FEED_ASSIST`

Включить ассистент подачи для указанного слота.

**Синтаксис:**
```gcode
ACE_ENABLE_FEED_ASSIST INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Что делает:**
- Включает механизм автоматической подачи филамента
- Помогает поддерживать натяжение филамента во время печати
- Обычно используется автоматически при парковке

**Пример:**
```gcode
ACE_ENABLE_FEED_ASSIST INDEX=0
```

**Примечание:** Ассистент может быть автоматически отключен после смены инструмента (зависит от настройки `disable_assist_after_toolchange`).

---

### `ACE_DISABLE_FEED_ASSIST`

Выключить ассистент подачи для указанного слота.

**Синтаксис:**
```gcode
ACE_DISABLE_FEED_ASSIST INDEX=<0-3>
```

**Параметры:**
- `INDEX` (обязательный) - Номер слота (0-3)

**Пример:**
```gcode
ACE_DISABLE_FEED_ASSIST INDEX=0
```

**Примечание:** Если `INDEX` не указан, используется текущий активный слот.

---

## Управление сушкой

### `ACE_START_DRYING`

Запустить процесс сушки филамента.

**Синтаксис:**
```gcode
ACE_START_DRYING TEMP=<температура> DURATION=<время>
```

**Параметры:**
- `TEMP` (обязательный) - Температура сушки в градусах Цельсия (20-55, ограничение `max_dryer_temperature`)
- `DURATION` (опциональный) - Продолжительность в минутах (по умолчанию 240, максимум 240)

**Примеры:**
```gcode
ACE_START_DRYING TEMP=50 DURATION=120    # Сушить 2 часа при 50°C
ACE_START_DRYING TEMP=45                # Сушить 4 часа при 45°C (по умолчанию)
```

**Что происходит:**
- Включается нагреватель сушилки
- Запускаются вентиляторы (7000 RPM)
- Температура поддерживается на заданном уровне
- После завершения времени вентиляторы продолжают работать до остывания

**Ограничения:**
- Максимальная температура: 55°C (или значение из `max_dryer_temperature`)
- Максимальное время: 240 минут (4 часа)

## Отладочные команды

### `ACE_DEBUG`

Отладочная команда для прямого взаимодействия с устройством ACE.

**Синтаксис:**
```gcode
ACE_DEBUG METHOD=<метод> PARAMS=<параметры>
```

**Параметры:**
- `METHOD` (обязательный) - Метод RPC:
  - `get_info` - Получить информацию об устройстве
  - `get_status` - Получить статус устройства
- `PARAMS` (опциональный) - Параметры в формате JSON (по умолчанию `{}`)

**Примеры:**
```gcode
# Получить информацию об устройстве
ACE_DEBUG METHOD=get_info

# Получить статус
ACE_DEBUG METHOD=get_status

# С параметрами
ACE_DEBUG METHOD=get_filament_info PARAMS={"index":0}
```

**Использование:**
- Проверка подключения к устройству
- Диагностика проблем
- Прямое взаимодействие с протоколом ACE

**Примечание:** См. [Protocol.md](Protocol.md) для полного списка доступных методов.

---

## Связь и соединение

### `ACE_DISCONNECT`

Принудительное отключение от устройства ACE.

**Синтаксис:**
```gcode
ACE_DISCONNECT
```

**Что делает:**
- Принудительно отключает устройство ACE от Klipper
- Останавливает все таймеры и соединения
- Очищает все ожидающие запросы
- Обновляет статус устройства на `disconnected`

**Пример:**
```gcode
ACE_DISCONNECT
```

**Примечание:** После отключения устройство можно подключить обратно с помощью `ACE_CONNECT`.

---

### `ACE_CONNECT`

Подключение к устройству ACE.

**Синтаксис:**
```gcode
ACE_CONNECT
```

**Что делает:**
- Пытается подключиться к устройству ACE
- Если уже подключено, сообщает об этом
- Запускает все необходимые таймеры для работы

**Пример:**
```gcode
ACE_CONNECT
```

**Примечание:** Обычно подключение происходит автоматически при запуске Klipper, но эту команду можно использовать для повторного подключения после `ACE_DISCONNECT`.

---

### `ACE_CONNECTION_STATUS`

Проверка статуса соединения с устройством ACE.

**Синтаксис:**
```gcode
ACE_CONNECTION_STATUS
```

**Что делает:**
- Проверяет текущий статус соединения
- Выводит информацию о подключении
- Если подключено, показывает модель и прошивку устройства
- Если отключено, показывает параметры соединения (порт, скорость)

**Пример:**
```gcode
ACE_CONNECTION_STATUS
```

**Примечание:** Полезно для диагностики проблем с подключением.

---

### `ACE_CHECK_FILAMENT_SENSOR`

Проверка статуса внешнего датчика филамента (если он настроен).

**Синтаксис:**
```gcode
ACE_CHECK_FILAMENT_SENSOR
```

**Что делает:**
- Проверяет статус внешнего датчика филамента
- Выводит информацию о наличии филамента
- Показывает статус датчика (включен/выключен)

**Пример:**
```gcode
ACE_CHECK_FILAMENT_SENSOR
```

**Примечание:** Команда работает только если в конфигурации задан параметр `filament_sensor`.

---


### `ACE_STOP_DRYING`

Остановить процесс сушки.

**Синтаксис:**
```gcode
ACE_STOP_DRYING
```

**Что делает:**
- Останавливает нагреватель сушилки
- Вентиляторы продолжают работать до полного остывания нагревателей

**Пример:**
```gcode
ACE_STOP_DRYING
```

---

## Отладочные команды

### `ACE_DEBUG`

Отладочная команда для прямого взаимодействия с устройством ACE.

**Синтаксис:**
```gcode
ACE_DEBUG METHOD=<метод> PARAMS=<параметры>
```

**Параметры:**
- `METHOD` (обязательный) - Метод RPC:
  - `get_info` - Получить информацию об устройстве
  - `get_status` - Получить статус устройства
- `PARAMS` (опциональный) - Параметры в формате JSON (по умолчанию `{}`)

**Примеры:**
```gcode
# Получить информацию об устройстве
ACE_DEBUG METHOD=get_info

# Получить статус
ACE_DEBUG METHOD=get_status

# С параметрами
ACE_DEBUG METHOD=get_filament_info PARAMS={"index":0}
```

**Использование:**
- Проверка подключения к устройству
- Диагностика проблем
- Прямое взаимодействие с протоколом ACE

**Примечание:** См. [Protocol.md](Protocol.md) для полного списка доступных методов.

---

## Режим бесконечной катушки

### `ACE_SET_INFINITY_SPOOL_ORDER`

Установить порядок смены слотов для режима infinity spool.

**Синтаксис:**
```gcode
ACE_SET_INFINITY_SPOOL_ORDER ORDER="<порядок>"
```

**Параметры:**
- `ORDER` (обязательный) - Порядок слотов в формате `"0,1,2,3"` или `"0,1,none,3"`
  - Используйте числа 0-3 для слотов
  - Используйте `none` для пустых слотов, которые нужно пропустить

**Примеры:**
```gcode
# Простой порядок: 0 → 1 → 2 → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# С пропуском слота 2: 0 → 1 → (пропуск) → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"

# Произвольный порядок: 2 → 0 → 1 → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="2,0,1,3"

# Через макрос
SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"
```

**Что делает:**
- Сохраняет порядок смены слотов в переменную `ace_infsp_order`
- Сбрасывает текущую позицию в порядке (начинает с начала)
- Валидирует порядок (должно быть ровно 4 элемента)

**Примечания:**
- Порядок должен быть установлен перед использованием `ACE_INFINITY_SPOOL`
- Порядок сохраняется между перезапусками (если используется `save_variables`)
- Можно изменить порядок в любой момент

---

### `ACE_INFINITY_SPOOL`

Автоматическая смена катушки при окончании филамента.

**Синтаксис:**
```gcode
ACE_INFINITY_SPOOL
```

**Что делает:**
- Переключается на следующий слот согласно установленному порядку
- Не выполняет откат (филамент уже закончился)
- Автоматически пропускает слоты, помеченные как `none`
- Циклически переходит к началу после последнего слота

**Требования:**
- В конфигурации должно быть: `infinity_spool_mode: True`
- Порядок слотов должен быть установлен через `ACE_SET_INFINITY_SPOOL_ORDER`
- Минимум один слот в порядке должен быть готов (`ready`)

**Пример использования:**
```gcode
# 1. Сначала установить порядок
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# 2. При обнаружении окончания филамента в макросах слайсера
ACE_INFINITY_SPOOL
```

**Процесс:**
1. Проверка режима infinity_spool
2. Получение порядка слотов из переменной `ace_infsp_order`
3. Поиск текущего слота в порядке
4. Определение следующего слота согласно порядку (пропуская `none`)
5. Проверка готовности следующего слота
6. Выполнение макроса `_ACE_PRE_INFINITYSPOOL`
7. Парковка нового филамента
8. Выполнение макроса `_ACE_POST_INFINITYSPOOL`
9. Сохранение новой позиции в порядке

**Логика работы:**
- Функция находит текущий активный слот в установленном порядке
- Ищет следующий валидный слот (пропуская `none`)
- Если дошли до конца порядка, циклически возвращается к началу
- Сохраняет текущую позицию в порядке для следующей смены

**Ограничения:**
- Максимум 4 слота (0-3)
- Работает только при включенном режиме
- Требует предварительной установки порядка
- Требует готовности следующего слота в порядке

**Переменные:**
- `ace_infsp_order` - порядок слотов (строка, например: `"0,1,none,3"`)
- `ace_infsp_position` - текущая позиция в порядке (0-3)

---

### `RESET_INFINITY_SPOOL`

Сбросить позицию в порядке infinity spool (начать с начала).

**Синтаксис:**
```gcode
RESET_INFINITY_SPOOL
```

**Что делает:**
- Сбрасывает переменную `ace_infsp_position` в 0
- Следующая смена начнется с первого слота в порядке

**Пример:**
```gcode
RESET_INFINITY_SPOOL
```

---

## Алиасы команд

Для удобства доступны короткие алиасы стандартных команд:

### `T0`, `T1`, `T2`, `T3`

Быстрая смена инструмента на соответствующий слот.

**Примеры:**
```gcode
T0  # Эквивалентно: ACE_CHANGE_TOOL TOOL=0
T1  # Эквивалентно: ACE_CHANGE_TOOL TOOL=1
T2  # Эквивалентно: ACE_CHANGE_TOOL TOOL=2
T3  # Эквивалентно: ACE_CHANGE_TOOL TOOL=3
```

### `TR`

Выгрузить текущий филамент.

**Пример:**
```gcode
TR  # Эквивалентно: ACE_CHANGE_TOOL TOOL=-1
```

---

## Макросы G-code

В файле `ace.cfg` определены дополнительные макросы для интеграции со слайсерами:

### `_ACE_PRE_TOOLCHANGE`

Макрос выполняется перед сменой инструмента.

**Параметры:**
- `FROM` - Индекс предыдущего инструмента (-1 если не было)
- `TO` - Индекс нового инструмента

**Использование:** Настраивается в `ace.cfg` под вашу конфигурацию принтера.

### `_ACE_POST_TOOLCHANGE`

Макрос выполняется после смены инструмента.

**Параметры:**
- `FROM` - Индекс предыдущего инструмента
- `TO` - Индекс нового инструмента

### `SET_INFINITY_SPOOL_ORDER`

Удобный макрос для установки порядка слотов infinity spool.

**Синтаксис:**
```gcode
SET_INFINITY_SPOOL_ORDER ORDER="<порядок>"
```

**Примеры:**
```gcode
SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"
SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"
```

### `RESET_INFINITY_SPOOL`

Макрос для сброса позиции в порядке infinity spool.

**Синтаксис:**
```gcode
RESET_INFINITY_SPOOL
```

### `_ACE_PRE_INFINITYSPOOL`

Макрос выполняется перед сменой катушки в режиме infinity spool.

**Использование:** Настраивается в `ace.cfg` под вашу конфигурацию принтера.

### `_ACE_POST_INFINITYSPOOL`

Макрос выполняется после смены катушки в режиме infinity spool.

**Использование:** Настраивается в `ace.cfg` под вашу конфигурацию принтера.

### `_ACE_ON_EMPTY_ERROR`

Макрос выполняется при обнаружении пустого слота.

**Параметры:**
- `INDEX` - Индекс пустого слота

**По умолчанию:** Паузит печать и показывает сообщение об ошибке.

---

## Примеры использования

### Полная смена инструмента

```gcode
# Загрузить слот 0
ACE_CHANGE_TOOL TOOL=0

# Или через алиас
T0
```

### Подача и откат филамента

```gcode
# Подать 50мм филамента из слота 0
ACE_FEED INDEX=0 LENGTH=50 SPEED=25

# Откатить 30мм филамента обратно
ACE_RETRACT INDEX=0 LENGTH=30 SPEED=20
```

### Сушка филамента

```gcode
# Запустить сушку на 2 часа при 50°C
ACE_START_DRYING TEMP=50 DURATION=120

# Остановить сушку
ACE_STOP_DRYING
```

### Режим infinity spool

```gcode
# 1. Установить порядок смены слотов
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# Или с пропуском пустого слота:
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"

# 2. При окончании филамента во время печати
ACE_INFINITY_SPOOL

# Автоматически переключится на следующий слот согласно порядку

# 3. Сброс позиции (начать с начала порядка)
RESET_INFINITY_SPOOL
```

### Диагностика

```gcode
# Проверить статус
ACE_STATUS

# Получить информацию об устройстве
ACE_DEBUG METHOD=get_info

# Информация о филаменте
ACE_FILAMENT_INFO INDEX=0
```

---

## Обработка ошибок

Все команды возвращают информацию об ошибках через:
- Сообщения в консоли G-code
- Логи Klipper (`~/printer_data/logs/klippy.log`)
- Статус через `ACE_STATUS`

**Типичные ошибки:**
- `ACE Error: Slot is not ready` - Слот пуст или не готов
- `ACE Error: Parking failed` - Ошибка парковки филамента
- `ACE Error: Connection lost` - Потеря связи с устройством

---

*Дата последнего обновления: 2025*

