# Протокол Anycubic ACE Pro
=========================

Транспортный уровень
====================

ACE Pro общается через USB, используя USB CDC устройство, без контроля потока и проверки целостности данных. Похоже, что устройство использует единый кольцевой буфер для ввода и вывода, и слишком быстрая отправка пакетов может привести к потере данных. Отправка пакетов до получения ответа может привести к потере данных, которые принтер пытался отправить. Максимальный безопасный объем данных для отправки за короткий промежуток времени составляет 1024 байта, но это может измениться в будущем.

Фрейминг
========

Каждая JSON команда упаковывается в фрейм следующего формата:

- 2 байта: 0xFF 0xAA
- 2 байта: Длина полезной нагрузки (little endian)
- Сам JSON
- 2 байта: CRC-16/MCRF4XX код JSON (little endian)
- Любое количество байтов, игнорируется (не добавляйте)
- 1 байт: 0xFE

ACE отключится и переподключится, если полный фрейм не был отправлен в течение 3 секунд, независимо от того, имеет ли фрейм валидную длину или CRC. Keepalive игнорирует данные из предыдущего подключения: фреймы могут быть разделены между несколькими подключениями.

Заголовок состоит из двух байтов, поэтому в случае повреждения одного из байтов фрейм будет проигнорирован, если только фрейм не содержит 0xFF 0xAA внутри. Если заголовок поврежден и фрейм содержит 0xFF 0xAA, ACE может зависнуть на некоторое время, пытаясь прочитать большой фрейм. Вы можете попытаться предотвратить это, перегенерируя полезную нагрузку до тех пор, пока CRC не совпадет с 0xFF 0xAA (little endian).

Если запрашивается длинный фрейм (более 1024 байт) случайно или намеренно, ACE, похоже, зависает и входит в невосстановимое состояние. Никакое количество данных, отправленных для завершения полезной нагрузки фрейма, не разморозит устройство.

RPC
===

**ПРЕДУПРЕЖДЕНИЕ**: Ничто из этого не было протестировано и может быть полностью неверным.

Каждый запрос отправляется в ACE Pro и содержит следующие JSON данные:

- id: Номер сообщения
- method: Строка, идентифицирующая метод
- params: Словарь параметров, специфичных для метода, опустите если пусто

Каждый ответ отправляется из ACE и содержит следующие JSON данные:

- id: Номер сообщения запроса
- result: Словарь возвращаемых данных, специфичных для метода
- code: Код возврата, специфичный для метода
- msg: Сообщение, специфичное для метода

Убедитесь, что вы блокируете доступ к ACE при отправке запроса и чтении ответа. Это легко упустить, если у вас есть фоновый поток, который работает для поддержания соединения живым, отправляя команду каждую секунду.

Методы
======

В этом разделе документируются методы, которые вы можете вызывать, и данные, которые вы получите обратно. Для неизвестных значений указаны статические значения.

Это не полная документация API, так как мы не контролируем прошивку и не имеем полномочий над ACE или его будущими обновлениями.

enable_rfid
-----------

Параметры запроса:

- Нет

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

disable_rfid
------------

Параметры запроса:

- Нет

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

get_info
--------

Параметры запроса:

- Нет

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:

- id: 0
- slots: 4
- model: "Anycubic Color Engine Pro"
- firmware: "V1.3.82"
- boot_firmware: "V1.0.1"

get_filament_info
-----------------

Параметры запроса:

- index: Номер слота филамента

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:

- index: Номер слота филамента
- sku: "ABCDEF-01"
- brand: "FakeBrand"
- type: "PLA", "PLA+", "TPU", "ABS", "PETG" и т.д.
- color: [0, 0, 0] (Красный, зеленый, синий в десятичных значениях 0-255)
- rfid: 0 (Информация не найдена), 1 (Не удалось идентифицировать), 2 (Идентифицировано), 3 (Идентификация)
- extruder_temp: Словарь данных о температуре
- hotbed_temp: Словарь данных о температуре
- diameter: 1.75 (Диаметр филамента в миллиметрах)
- total: 330
- current: 0

Словарь данных о температуре:

- min: Температура в градусах Цельсия, целое число
- max: Температура в градусах Цельсия, целое число

get_status
----------

Параметры запроса:

- Нет

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:

- status: "ready", "busy"
- action: "feeding", "unwinding", "shifting" (переключение передач)
- dryer_status: Словарь статуса сушилки
- temp: Температура сушилки в градусах Цельсия
- enable_rfid: 1
- fan_speed: Скорость вентилятора в об/мин
- feed_assist_count: 0
- cont_assist_time: 0.0 (Время непрерывной подачи в миллисекундах)
- slots: Массив словарей статуса слотов

Словарь статуса сушилки:
- status: "stop", "drying"
- target_temp: 60
- duration: 300 (Минуты)
- remain_time: 50 (Минуты)

Словарь статуса слота:
- index: Номер слота филамента
- status: "ready"
- sku: "ABCDEF-01"
- brand: "FakeBrand"
- type: "PLA", "PLA+", "TPU", "ABS", "PETG" и т.д.
- color: [0, 0, 0] (Красный, зеленый, синий в десятичных значениях 0-255)
- rfid: 0 (Информация не найдена), 1 (Не удалось идентифицировать), 2 (Идентифицировано), 3 (Идентификация)

drying
------

Параметры запроса:

- temp: Температура сушилки в градусах Цельсия
- fan_speed: 7000 (об/мин)
- duration: 240 (минуты)

Данные ответа:
- msg: "drying"
- code: 0

Параметры ответа:
- Нет

drying_stop
-----------

Параметры запроса:

- Нет

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

unwind_filament
---------------

Параметры запроса:

- index: Номер слота филамента
- length: 300, 70
- speed: 10, 15
- mode: 0 (обычный режим), 1 (улучшенный режим)

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

update_unwinding_speed
----------------------

Параметры запроса:

- index: Номер слота филамента
- speed: 15

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

stop_unwind_filament
--------------------

Параметры запроса:

- index: Номер слота филамента

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

feed_filament
-------------

Параметры запроса:

- index: Номер слота филамента
- length: 2000
- speed: 25

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

update_feeding_speed
--------------------

Параметры запроса:

- index: Номер слота филамента
- speed: 25

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

stop_feed_filament
------------------

Параметры запроса:

- index: Номер слота филамента

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

start_feed_assist
-----------------

Параметры запроса:

- index: Номер слота филамента

Данные ответа:
- msg: "success"
- code: 0

Параметры ответа:
- Нет

stop_feed_assist
----------------

Параметры запроса:

- index: Номер слота филамента

Данные ответа:
- msg: ""
- code: 0

Параметры ответа:
- Нет

