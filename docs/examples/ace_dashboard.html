<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValgACE Status Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-ready {
            background: #4caf50;
            color: white;
        }

        .status-busy {
            background: #ff9800;
            color: white;
        }

        .status-disconnected {
            background: #f44336;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: bold;
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .slot-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .slot-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .slot-card.ready {
            border-left-color: #4caf50;
        }

        .slot-card.empty {
            border-left-color: #9e9e9e;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slot-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .slot-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .slot-status.ready {
            background: #4caf50;
            color: white;
        }

        .slot-status.empty {
            background: #9e9e9e;
            color: white;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            margin: 10px 0;
        }

        .dryer-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® ValgACE Status Dashboard</h1>
            <div>
                <span class="status-badge" id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                <span id="lastUpdate" style="color: #666; margin-left: 15px; font-size: 14px;"></span>
            </div>
        </div>

        <div class="grid">
            <!-- Device Info Card -->
            <div class="card">
                <h2>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h2>
                <div id="deviceInfo" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <!-- Dryer Card -->
            <div class="card">
                <h2>üå°Ô∏è –°—É—à–∫–∞ —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞</h2>
                <div id="dryerInfo" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="dryer-controls">
                    <button class="btn btn-primary" onclick="startDrying()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—É—à–∫—É</button>
                    <button class="btn btn-danger" onclick="stopDrying()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <!-- Parameters Card -->
            <div class="card">
                <h2>‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
                <div id="parametersInfo" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- Slots Card -->
        <div class="card">
            <h2>üéØ –°–ª–æ—Ç—ã —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞</h2>
            <div id="slotsContainer" class="slots-grid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–æ–≤...</div>
            </div>
        </div>
    </div>

    <script>
        const MOONRAKER_URL = window.location.origin; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω
        let ws = null;
        let updateInterval = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadStatus();
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            updateInterval = setInterval(loadStatus, 5000);
        });

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.hostname}:7125/websocket`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                
                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
                ws.send(JSON.stringify({
                    jsonrpc: "2.0",
                    method: "printer.objects.subscribe",
                    params: {
                        objects: {
                            "ace": null
                        }
                    },
                    id: 5434
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.method === "notify_status_update") {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
                    if (data.params && data.params[0] && data.params[0].ace) {
                        updateUI(data.params[0].ace);
                    }
                }
            };

            ws.onerror = () => {
                updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            };

            ws.onclose = () => {
                updateConnectionStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(connectWebSocket, 5000);
            };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ REST API
        async function loadStatus() {
            try {
                const response = await fetch(`${MOONRAKER_URL}/server/ace/status`);
                const data = await response.json();
                
                if (data.result) {
                    updateUI(data.result);
                    updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                } else if (data.error) {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Error loading status:', error);
                updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                // Fallback: –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ G-code –∫–æ–º–∞–Ω–¥—É
                loadStatusViaGcode();
            }
        }

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ G-code –∫–æ–º–∞–Ω–¥—É
        async function loadStatusViaGcode() {
            try {
                const response = await fetch(`${MOONRAKER_URL}/server/printer/gcode/script`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script: 'ACE_STATUS' })
                });
                const data = await response.json();
                // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω –ø–∞—Ä—Å–µ—Ä)
                console.log('G-code response:', data);
            } catch (error) {
                console.error('Error loading via G-code:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI(status) {
            updateDeviceInfo(status);
            updateDryerInfo(status);
            updateParametersInfo(status);
            updateSlots(status.slots || []);
            updateLastUpdate();
        }

        function updateDeviceInfo(status) {
            const html = `
                <div class="info-row">
                    <span class="info-label">–ú–æ–¥–µ–ª—å:</span>
                    <span class="info-value">${status.model || 'Unknown'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ü—Ä–æ—à–∏–≤–∫–∞:</span>
                    <span class="info-value">${status.firmware || 'Unknown'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="info-value">${status.status || 'unknown'}</span>
                </div>
            `;
            document.getElementById('deviceInfo').innerHTML = html;
        }

        function updateDryerInfo(status) {
            const dryer = status.dryer || status.dryer_status || {};
            const isDrying = dryer.status === 'drying';
            
            const html = `
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="info-value">${dryer.status === 'drying' ? '–°—É—à–∫–∞' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
                    <span class="info-value">${status.temp || 0}¬∞C</span>
                </div>
                ${isDrying ? `
                    <div class="info-row">
                        <span class="info-label">–¶–µ–ª–µ–≤–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
                        <span class="info-value">${dryer.target_temp || 0}¬∞C</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏:</span>
                        <span class="info-value">${formatTime(dryer.remain_time || 0)}</span>
                    </div>
                ` : ''}
            `;
            document.getElementById('dryerInfo').innerHTML = html;
        }

        function updateParametersInfo(status) {
            const html = `
                <div class="info-row">
                    <span class="info-label">–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞:</span>
                    <span class="info-value">${status.fan_speed || 0} RPM</span>
                </div>
                <div class="info-row">
                    <span class="info-label">RFID:</span>
                    <span class="info-value">${status.enable_rfid ? '–í–∫–ª—é—á–µ–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Feed Assist:</span>
                    <span class="info-value">${status.feed_assist_count || 0}</span>
                </div>
            `;
            document.getElementById('parametersInfo').innerHTML = html;
        }

        function updateSlots(slots) {
            const container = document.getElementById('slotsContainer');
            if (!slots || slots.length === 0) {
                container.innerHTML = '<div class="error">–°–ª–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            container.innerHTML = slots.map(slot => {
                const statusClass = slot.status === 'ready' ? 'ready' : 'empty';
                const color = slot.color || [0, 0, 0];
                const colorStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                
                return `
                    <div class="slot-card ${statusClass}">
                        <div class="slot-header">
                            <span class="slot-number">–°–ª–æ—Ç ${slot.index}</span>
                            <span class="slot-status ${statusClass}">${getStatusText(slot.status)}</span>
                        </div>
                        <div class="color-preview" style="background-color: ${colorStyle}"></div>
                        ${slot.type ? `<div class="info-row"><span class="info-label">–¢–∏–ø:</span><span class="info-value">${slot.type}</span></div>` : ''}
                        ${slot.sku ? `<div class="info-row"><span class="info-label">SKU:</span><span class="info-value">${slot.sku}</span></div>` : ''}
                        <div class="info-row">
                            <span class="info-label">RFID:</span>
                            <span class="info-value">${getRfidText(slot.rfid)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateConnectionStatus(status, text) {
            const badge = document.getElementById('connectionStatus');
            badge.textContent = text;
            badge.className = 'status-badge status-' + status;
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now.toLocaleTimeString()}`;
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}—á ${mins}–º`;
        }

        function getStatusText(status) {
            const statusMap = {
                'ready': '–ì–æ—Ç–æ–≤',
                'empty': '–ü—É—Å—Ç–æ',
                'busy': '–ó–∞–Ω—è—Ç'
            };
            return statusMap[status] || status;
        }

        function getRfidText(rfid) {
            const rfidMap = {
                0: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',
                1: '–û—à–∏–±–∫–∞',
                2: '–ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ',
                3: '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...'
            };
            return rfidMap[rfid] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = `–û—à–∏–±–∫–∞: ${message}`;
            container.insertBefore(errorDiv, container.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        async function startDrying() {
            const temp = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Å—É—à–∫–∏ (20-55¬∞C):', '50');
            const duration = prompt('–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö:', '240');
            
            if (temp && duration) {
                try {
                    await fetch(`${MOONRAKER_URL}/server/ace/command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            command: 'ACE_START_DRYING',
                            params: { TEMP: parseInt(temp), DURATION: parseInt(duration) }
                        })
                    });
                    loadStatus();
                } catch (error) {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—É—à–∫–∏: ' + error.message);
                }
            }
        }

        async function stopDrying() {
            try {
                await fetch(`${MOONRAKER_URL}/server/ace/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        command: 'ACE_STOP_DRYING'
                    })
                });
                loadStatus();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—É—à–∫–∏: ' + error.message);
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
            if (ws) ws.close();
        });
    </script>
</body>
</html>

