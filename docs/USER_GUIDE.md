# Руководство пользователя ValgACE

Подробное руководство по использованию модуля ValgACE для управления устройством Anycubic Color Engine Pro.

## Содержание

1. [Введение](#введение)
2. [Основные понятия](#основные-понятия)
3. [Веб-интерфейс Dashboard](#веб-интерфейс-dashboard)
4. [Первое использование](#первое-использование)
5. [Смена инструмента](#смена-инструмента)
6. [Управление филаментом](#управление-филаментом)
7. [Управление сушкой](#управление-сушкой)
8. [Режим бесконечной катушки](#режим-бесконечной-катушки)
9. [Интеграция со слайсерами](#интеграция-со-слайсерами)
10. [Типичные сценарии](#типичные-сценарии)

---

## Введение

ValgACE предоставляет полный контроль над устройством Anycubic Color Engine Pro через команды G-code в Klipper. Это руководство поможет вам освоить все возможности модуля.

### Что вы узнаете

- Как проверить подключение устройства
- Как загружать и выгружать филамент
- Как использовать автоматическую смену инструмента
- Как настроить сушку филамента
- Как интегрировать с слайсерами для многокрасочной печати

---

## Основные понятия

### Слоты (Slots)

Устройство ACE Pro поддерживает **4 слота** для филамента:
- **Индексы:** 0, 1, 2, 3
- **Статус:** Каждый слот может быть `ready` (готов) или `empty` (пуст)

### Инструменты (Tools)

- **TOOL=-1:** Выгрузить филамент (нет инструмента)
- **TOOL=0-3:** Загрузить филамент из соответствующего слота

### Парковка (Parking)

Процесс подачи филамента от ACE до сопла принтера. Определяется успешной по стабилизации счетчика ударов филамента о концевой выключатель.

### Feed Assist

Ассистент подачи - механизм автоматической поддержки натяжения филамента во время печати.

---

## Веб-интерфейс Dashboard

ValgACE Dashboard — это современный веб-интерфейс для управления ACE через браузер. Он предоставляет удобный графический интерфейс для всех операций управления устройством.

### Установка Dashboard

Подробные инструкции по установке см. в [README веб-интерфейса](../../web-interface/README.md).

**Быстрая установка:**

1. Скопируйте файлы:
   ```bash
   mkdir -p ~/ace-dashboard
   cp ~/ValgACE/web-interface/ace-dashboard.* ~/ace-dashboard/
   ```

2. Запустите HTTP сервер:
   ```bash
   cd ~/ace-dashboard
   python3 -m http.server 8080
   ```

3. Откройте в браузере: `http://<IP-принтера>:8080/ace-dashboard.html`

### Основные возможности Dashboard

#### Мониторинг статуса

- **Статус устройства** — отображается в реальном времени (модель, прошивка, температура, вентилятор)
- **Индикатор подключения** — показывает состояние WebSocket соединения
- **Автоматическое обновление** — статус обновляется каждые 5 секунд

#### Управление слотами

Для каждого слота доступны следующие действия:

- **Загрузить** — загружает филамент из слота (`ACE_CHANGE_TOOL`)
- **Парковка** — паркует филамент к хотэнду (`ACE_PARK_TO_TOOLHEAD`)
- **Асист** — включает/выключает feed assist для слота (`ACE_ENABLE_FEED_ASSIST` / `ACE_DISABLE_FEED_ASSIST`)
  - Кнопка зеленая с текстом "Асист ВКЛ" когда активна
  - Кнопка с зеленой обводкой "Асист" когда неактивна
- **Подача** — открывает диалог для подачи филамента на заданную длину
- **Откат** — открывает диалог для отката филамента на заданную длину

#### Управление сушкой

- Установка целевой температуры (20-55°C)
- Установка длительности сушки (в минутах)
- Запуск и остановка процесса сушки
- Отображение оставшегося времени

#### Быстрые действия

- **Выгрузить филамент** — быстро выгружает текущий филамент
- **Обновить статус** — принудительно обновляет статус устройства

### Использование Dashboard

1. **Откройте интерфейс** в браузере
2. **Проверьте подключение** — индикатор должен быть зеленым
3. **Проверьте статус слотов** — слоты со статусом "Готов" доступны для использования
4. **Выберите действие** — нажмите нужную кнопку для выполнения операции

### Настройка Dashboard

Отредактируйте `ace-dashboard-config.js` для настройки:

- Адрес Moonraker API
- Интервалы обновления
- Значения по умолчанию для команд

Подробнее см. комментарии в файле конфигурации.

---

## Первое использование

### Шаг 1: Проверка подключения

После установки и настройки проверьте подключение:

```gcode
ACE_STATUS
```

Должен вернуться статус устройства. Если статус `disconnected`, проверьте:
- USB подключение
- Настройки порта в `ace.cfg`
- Логи Klipper

### Шаг 2: Получение информации об устройстве

```gcode
ACE_DEBUG METHOD=get_info
```

Должна вернуться информация:
- Модель устройства
- Версия прошивки
- Количество слотов

### Шаг 3: Проверка состояния слотов

```gcode
ACE_STATUS
```

Проверьте информацию о слотах в ответе. Слоты со статусом `ready` готовы к использованию.

---

## Смена инструмента

### Загрузка филамента

**Базовый способ:**
```gcode
ACE_CHANGE_TOOL TOOL=0
```

**Через алиас:**
```gcode
T0  # То же самое
```

**Что происходит:**
1. Проверка текущего инструмента
2. Если другой инструмент был загружен - откат старого филамента
3. Ожидание готовности слота после отката
4. Парковка нового филамента к соплу
5. Готово к печати

### Выгрузка филамента

```gcode
ACE_CHANGE_TOOL TOOL=-1
```

Или через алиас:
```gcode
TR
```

### Смена с одного слота на другой

```gcode
# Было: T0, нужно: T2
ACE_CHANGE_TOOL TOOL=2
```

Модуль автоматически:
- Откатит филамент из слота 0
- Подождет готовности слота 0
- Загрузит филамент из слота 2
- Припаркует филамент к соплу

---

## Управление филаментом

### Подача филамента

```gcode
ACE_FEED INDEX=0 LENGTH=50 SPEED=25
```

**Параметры:**
- `INDEX` - номер слота (0-3)
- `LENGTH` - длина подачи в мм
- `SPEED` - скорость подачи в мм/с (опционально)

**Примеры:**
```gcode
# Подать 50мм из слота 0
ACE_FEED INDEX=0 LENGTH=50 SPEED=25

# Подать 100мм с дефолтной скоростью
ACE_FEED INDEX=2 LENGTH=100
```

### Откат филамента

```gcode
ACE_RETRACT INDEX=0 LENGTH=50 SPEED=25 MODE=0
```

**Параметры:**
- `INDEX` - номер слота (0-3)
- `LENGTH` - длина отката в мм
- `SPEED` - скорость отката в мм/с (опционально)
- `MODE` - режим отката (0=обычный, 1=улучшенный)

**Примеры:**
```gcode
# Откатить 50мм обычным режимом
ACE_RETRACT INDEX=0 LENGTH=50 SPEED=25 MODE=0

# Откатить 100мм улучшенным режимом
ACE_RETRACT INDEX=1 LENGTH=100 MODE=1
```

### Изменение скорости на лету

Во время подачи или отката можно изменить скорость:

```gcode
# Начать подачу
ACE_FEED INDEX=0 LENGTH=200 SPEED=20

# Замедлить подачу
ACE_UPDATE_FEEDING_SPEED INDEX=0 SPEED=15

# Остановить подачу
ACE_STOP_FEED INDEX=0
```

### Остановка операций

```gcode
# Остановить подачу
ACE_STOP_FEED INDEX=0

# Остановить откат
ACE_STOP_RETRACT INDEX=0
```

---

## Парковка филамента

### Ручная парковка

```gcode
ACE_PARK_TO_TOOLHEAD INDEX=0
```

**Что делает:**
- Запускает feed assist для указанного слота
- Филамент начинает подаваться к соплу
- Модуль отслеживает достижение сопла по счетчику
- Когда счетчик стабилизируется, парковка завершается
- Feed assist автоматически отключается

**Проверка статуса парковки:**
```gcode
ACE_STATUS
```

Смотрите значение `feed_assist_count` - оно увеличивается при каждом ударе филамента о сопло.

### Автоматическая парковка

Парковка выполняется автоматически при:
- Смене инструмента (`ACE_CHANGE_TOOL`)
- Использовании режима infinity spool

---

## Управление сушкой

### Запуск сушки

```gcode
ACE_START_DRYING TEMP=50 DURATION=120
```

**Параметры:**
- `TEMP` - температура сушки в °C (20-55)
- `DURATION` - продолжительность в минутах (максимум 240)

**Примеры:**
```gcode
# Сушить 2 часа при 50°C
ACE_START_DRYING TEMP=50 DURATION=120

# Сушить 4 часа при 45°C (максимальное время)
ACE_START_DRYING TEMP=45 DURATION=240
```

**Что происходит:**
- Включается нагреватель сушилки
- Запускаются вентиляторы (7000 RPM)
- Температура поддерживается на заданном уровне
- После завершения времени вентиляторы продолжают работать до остывания

### Проверка статуса сушки

```gcode
ACE_STATUS
```

Смотрите секцию `dryer`:
```json
{
  "dryer": {
    "status": "drying",
    "target_temp": 50,
    "duration": 240,
    "remain_time": 120
  },
  "temp": 48
}
```

### Остановка сушки

```gcode
ACE_STOP_DRYING
```

Вентиляторы продолжат работать до полного остывания нагревателей.

---

## Режим бесконечной катушки

### Настройка

Включите в `ace.cfg`:
```ini
infinity_spool_mode: True
```

### Установка порядка слотов

Перед использованием режима infinity spool необходимо установить порядок смены слотов:

```gcode
# Простой порядок: 0 → 1 → 2 → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# С пропуском пустого слота 2: 0 → 1 → (пропуск) → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"

# Произвольный порядок: 2 → 0 → 1 → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="2,0,1,3"
```

**Параметры порядка:**
- Используйте числа `0-3` для указания слотов
- Используйте `none` для пустых слотов, которые нужно пропустить
- Порядок должен содержать ровно 4 элемента

### Использование

Когда филамент заканчивается во время печати:

```gcode
ACE_INFINITY_SPOOL
```

**Что происходит:**
1. Получение порядка слотов из переменной `ace_infsp_order`
2. Поиск текущего активного слота в порядке
3. Определение следующего слота согласно порядку (пропуская `none`)
4. Проверка готовности следующего слота
5. Выполнение макроса `_ACE_PRE_INFINITYSPOOL`
6. Парковка нового филамента к соплу
7. Выполнение макроса `_ACE_POST_INFINITYSPOOL`
8. Сохранение новой позиции в порядке

**Особенности:**
- Порядок сохраняется между перезапусками (если используется `save_variables`)
- После последнего слота в порядке происходит циклический возврат к первому
- Слоты, помеченные как `none`, автоматически пропускаются
- Можно изменить порядок в любой момент через `ACE_SET_INFINITY_SPOOL_ORDER`

### Сброс позиции

Если нужно начать с начала порядка:

```gcode
RESET_INFINITY_SPOOL
```

Это сбросит текущую позицию в порядке, и следующая смена начнется с первого слота.

---

## Интеграция со слайсерами

### PrusaSlicer / SuperSlicer

В настройках принтера добавьте макросы смены инструмента:

**Начало печати:**
```gcode
T0  ; Загрузить слот 0
G28 ; Калибровка
```

**Смена цвета/материала:**
```gcode
T1  ; Сменить на слот 1
```

**Настройка в PrusaSlicer:**
1. Printer Settings → Custom G-code
2. Tool change G-code: `T[current_extruder]`
3. Before layer change G-code: (опционально)

### Cura

**Настройка смены инструмента:**

1. Extensions → Post Processing → Modify G-Code
2. Add Script → Tool Change
3. В поле "Tool Change G-code" добавьте:
```
T[tool]
```

### OrcaSlicer

Аналогично PrusaSlicer - используйте макросы `T0-T3` для смены инструмента.

---

## Типичные сценарии

### Сценарий 1: Первая загрузка филамента

```gcode
# 1. Проверить статус устройства
ACE_STATUS

# 2. Загрузить филамент из слота 0
T0

# 3. Проверить, что филамент загружен
ACE_STATUS
```

### Сценарий 2: Многокрасочная печать

**Подготовка:**
```gcode
# Загрузить все необходимые цвета
T0  # Красный
T1  # Синий
T2  # Желтый
```

**В слайсере:**
- Настройте смену инструмента через макросы `T0-T3`
- Каждый слой/секция будет использовать соответствующий инструмент

### Сценарий 3: Сушка филамента перед печатью

```gcode
# 1. Запустить сушку на 2 часа
ACE_START_DRYING TEMP=50 DURATION=120

# 2. Проверить статус (можно периодически)
ACE_STATUS

# 3. После завершения сушки - загрузить филамент
T0
```

### Сценарий 4: Замена пустого филамента

```gcode
# 1. Обнаружение пустого слота (автоматически через _ACE_ON_EMPTY_ERROR)
# Печать паузится

# 2. Загрузить новый филамент
T1  # Загрузить из слота 1

# 3. Продолжить печать
RESUME
```

### Сценарий 5: Использование infinity spool

**Настройка:**
```ini
# В ace.cfg
infinity_spool_mode: True
```

**Использование:**
```gcode
# 1. Сначала установить порядок смены слотов
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# Или с пропуском пустых слотов:
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"

# 2. Когда филамент закончился во время печати
ACE_INFINITY_SPOOL

# Автоматически переключится на следующий слот согласно порядку
```

**Примеры порядков:**
```gcode
# Простой порядок: 0 → 1 → 2 → 3
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"

# С пропуском слота 2: 0 → 1 → (пропуск) → 3 → 0 → ...
ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,none,3"

# Произвольный порядок: 2 → 0 → 1 → 3 → 2 → ...
ACE_SET_INFINITY_SPOOL_ORDER ORDER="2,0,1,3"

# Сброс позиции (начать с начала порядка)
RESET_INFINITY_SPOOL
```

**Примечания:**
- Порядок должен быть установлен перед использованием `ACE_INFINITY_SPOOL`
- Порядок сохраняется между перезапусками (если используется `save_variables`)
- Можно изменить порядок в любой момент
- Слоты, помеченные как `none`, автоматически пропускаются

### Сценарий 6: Ручная подача/откат для прочистки

```gcode
# Подать филамент для прочистки
ACE_FEED INDEX=0 LENGTH=100 SPEED=20

# Откатить обратно
ACE_RETRACT INDEX=0 LENGTH=100 SPEED=25
```

---

## Мониторинг и диагностика

### Проверка статуса устройства

```gcode
ACE_STATUS
```

**Что смотреть:**
- `status` - состояние устройства (`ready`, `busy`, `disconnected`)
- `slots` - информация о каждом слоте
- `dryer` - статус сушилки
- `temp` - текущая температура

### Проверка информации о филаменте

```gcode
ACE_FILAMENT_INFO INDEX=0
```

Работает только для филаментов с RFID метками.

### Отладочные команды

```gcode
# Получить информацию об устройстве
ACE_DEBUG METHOD=get_info

# Получить статус
ACE_DEBUG METHOD=get_status
```

### Просмотр логов

```bash
# Просмотр логов Klipper
tail -f ~/printer_data/logs/klippy.log | grep -i ace

# Просмотр с фильтром по уровню
tail -f ~/printer_data/logs/klippy.log | grep -i "ace.*debug"
```

---

## Рекомендации по использованию

### Перед началом печати

1. ✅ Проверьте статус всех слотов: `ACE_STATUS`
2. ✅ Убедитесь, что нужные слоты заполнены и готовы
3. ✅ При необходимости просушите филамент
4. ✅ Загрузите нужный инструмент: `T0` (или другой)

### Во время печати

- Не вмешивайтесь в работу автоматической смены инструмента
- Следите за статусом через веб-интерфейс
- При ошибках - проверьте логи

### После печати

- Можно выгрузить филамент: `TR`
- При необходимости просушить филамент
- Проверить состояние устройства: `ACE_STATUS`

---

## Часто задаваемые вопросы

### Q: Как узнать, какой инструмент сейчас загружен?

**A:** Используйте `ACE_STATUS` и проверьте переменную `ace_current_index` через `SAVE_VARIABLE` или посмотрите в логах.

### Q: Можно ли использовать только некоторые слоты?

**A:** Да, используйте только нужные слоты. Остальные должны быть пустыми или неиспользуемыми.

### Q: Что делать, если парковка не завершается?

**A:** 
1. Проверьте готовность слота: `ACE_STATUS`
2. Увеличьте `park_hit_count` в конфигурации
3. Проверьте логи на наличие ошибок

### Q: Как использовать режим infinity spool?

**A:** 
1. Включите режим в конфигурации: `infinity_spool_mode: True`
2. Установите порядок слотов: `ACE_SET_INFINITY_SPOOL_ORDER ORDER="0,1,2,3"`
3. Используйте `ACE_INFINITY_SPOOL` при окончании филамента
4. Для пустых слотов используйте `none`: `ORDER="0,1,none,3"`

### Q: Можно ли использовать ACE с другими MMU?

**A:** ValgACE предназначен специально для Anycubic Color Engine Pro. Для других MMU используйте соответствующие драйверы.

### Q: Как часто нужно проверять статус?

**A:** Обычно не требуется - модуль работает автоматически. Проверяйте только при проблемах или для диагностики.

---

*Дата последнего обновления: 2025*

