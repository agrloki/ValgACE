# Руководство пользователя ValgACE

Подробное руководство по использованию модуля ValgACE для управления устройством Anycubic Color Engine Pro.

## Содержание

1. [Введение](#введение)
2. [Основные понятия](#основные-понятия)
3. [Первое использование](#первое-использование)
4. [Смена инструмента](#смена-инструмента)
5. [Управление филаментом](#управление-филаментом)
6. [Управление сушкой](#управление-сушкой)
7. [Режим бесконечной катушки](#режим-бесконечной-катушки)
8. [Интеграция со слайсерами](#интеграция-со-слайсерами)
9. [Типичные сценарии](#типичные-сценарии)

---

## Введение

ValgACE предоставляет полный контроль над устройством Anycubic Color Engine Pro через команды G-code в Klipper. Это руководство поможет вам освоить все возможности модуля.

### Что вы узнаете

- Как проверить подключение устройства
- Как загружать и выгружать филамент
- Как использовать автоматическую смену инструмента
- Как настроить сушку филамента
- Как интегрировать с слайсерами для многокрасочной печати

---

## Основные понятия

### Слоты (Slots)

Устройство ACE Pro поддерживает **4 слота** для филамента:
- **Индексы:** 0, 1, 2, 3
- **Статус:** Каждый слот может быть `ready` (готов) или `empty` (пуст)

### Инструменты (Tools)

- **TOOL=-1:** Выгрузить филамент (нет инструмента)
- **TOOL=0-3:** Загрузить филамент из соответствующего слота

### Парковка (Parking)

Процесс подачи филамента от ACE до сопла принтера. Определяется успешной по стабилизации счетчика ударов филамента о концевой выключатель.

### Feed Assist

Ассистент подачи - механизм автоматической поддержки натяжения филамента во время печати.

---

## Первое использование

### Шаг 1: Проверка подключения

После установки и настройки проверьте подключение:

```gcode
ACE_STATUS
```

Должен вернуться статус устройства. Если статус `disconnected`, проверьте:
- USB подключение
- Настройки порта в `ace.cfg`
- Логи Klipper

### Шаг 2: Получение информации об устройстве

```gcode
ACE_DEBUG METHOD=get_info
```

Должна вернуться информация:
- Модель устройства
- Версия прошивки
- Количество слотов

### Шаг 3: Проверка состояния слотов

```gcode
ACE_STATUS
```

Проверьте информацию о слотах в ответе. Слоты со статусом `ready` готовы к использованию.

---

## Смена инструмента

### Загрузка филамента

**Базовый способ:**
```gcode
ACE_CHANGE_TOOL TOOL=0
```

**Через алиас:**
```gcode
T0  # То же самое
```

**Что происходит:**
1. Проверка текущего инструмента
2. Если другой инструмент был загружен - откат старого филамента
3. Ожидание готовности слота после отката
4. Парковка нового филамента к соплу
5. Готово к печати

### Выгрузка филамента

```gcode
ACE_CHANGE_TOOL TOOL=-1
```

Или через алиас:
```gcode
TR
```

### Смена с одного слота на другой

```gcode
# Было: T0, нужно: T2
ACE_CHANGE_TOOL TOOL=2
```

Модуль автоматически:
- Откатит филамент из слота 0
- Подождет готовности слота 0
- Загрузит филамент из слота 2
- Припаркует филамент к соплу

---

## Управление филаментом

### Подача филамента

```gcode
ACE_FEED INDEX=0 LENGTH=50 SPEED=25
```

**Параметры:**
- `INDEX` - номер слота (0-3)
- `LENGTH` - длина подачи в мм
- `SPEED` - скорость подачи в мм/с (опционально)

**Примеры:**
```gcode
# Подать 50мм из слота 0
ACE_FEED INDEX=0 LENGTH=50 SPEED=25

# Подать 100мм с дефолтной скоростью
ACE_FEED INDEX=2 LENGTH=100
```

### Откат филамента

```gcode
ACE_RETRACT INDEX=0 LENGTH=50 SPEED=25 MODE=0
```

**Параметры:**
- `INDEX` - номер слота (0-3)
- `LENGTH` - длина отката в мм
- `SPEED` - скорость отката в мм/с (опционально)
- `MODE` - режим отката (0=обычный, 1=улучшенный)

**Примеры:**
```gcode
# Откатить 50мм обычным режимом
ACE_RETRACT INDEX=0 LENGTH=50 SPEED=25 MODE=0

# Откатить 100мм улучшенным режимом
ACE_RETRACT INDEX=1 LENGTH=100 MODE=1
```

### Изменение скорости на лету

Во время подачи или отката можно изменить скорость:

```gcode
# Начать подачу
ACE_FEED INDEX=0 LENGTH=200 SPEED=20

# Замедлить подачу
ACE_UPDATE_FEEDING_SPEED INDEX=0 SPEED=15

# Остановить подачу
ACE_STOP_FEED INDEX=0
```

### Остановка операций

```gcode
# Остановить подачу
ACE_STOP_FEED INDEX=0

# Остановить откат
ACE_STOP_RETRACT INDEX=0
```

---

## Парковка филамента

### Ручная парковка

```gcode
ACE_PARK_TO_TOOLHEAD INDEX=0
```

**Что делает:**
- Запускает feed assist для указанного слота
- Филамент начинает подаваться к соплу
- Модуль отслеживает достижение сопла по счетчику
- Когда счетчик стабилизируется, парковка завершается
- Feed assist автоматически отключается

**Проверка статуса парковки:**
```gcode
ACE_STATUS
```

Смотрите значение `feed_assist_count` - оно увеличивается при каждом ударе филамента о сопло.

### Автоматическая парковка

Парковка выполняется автоматически при:
- Смене инструмента (`ACE_CHANGE_TOOL`)
- Использовании режима infinity spool

---

## Управление сушкой

### Запуск сушки

```gcode
ACE_START_DRYING TEMP=50 DURATION=120
```

**Параметры:**
- `TEMP` - температура сушки в °C (20-55)
- `DURATION` - продолжительность в минутах (максимум 240)

**Примеры:**
```gcode
# Сушить 2 часа при 50°C
ACE_START_DRYING TEMP=50 DURATION=120

# Сушить 4 часа при 45°C (максимальное время)
ACE_START_DRYING TEMP=45 DURATION=240
```

**Что происходит:**
- Включается нагреватель сушилки
- Запускаются вентиляторы (7000 RPM)
- Температура поддерживается на заданном уровне
- После завершения времени вентиляторы продолжают работать до остывания

### Проверка статуса сушки

```gcode
ACE_STATUS
```

Смотрите секцию `dryer`:
```json
{
  "dryer": {
    "status": "drying",
    "target_temp": 50,
    "duration": 240,
    "remain_time": 120
  },
  "temp": 48
}
```

### Остановка сушки

```gcode
ACE_STOP_DRYING
```

Вентиляторы продолжат работать до полного остывания нагревателей.

---

## Режим бесконечной катушки

### Настройка

Включите в `ace.cfg`:
```ini
infinity_spool_mode: True
```

### Использование

Когда филамент заканчивается во время печати:

```gcode
ACE_INFINITY_SPOOL
```

**Что происходит:**
1. Определяется следующий готовый слот
2. Проверяется готовность слота
3. Выполняется макрос `_ACE_PRE_INFINITYSPOOL`
4. Парковка нового филамента (без отката старого)
5. Выполняется макрос `_ACE_POST_INFINITYSPOOL`
6. Печать продолжается с новым филаментом

**Требования:**
- Минимум 2 слота должны быть готовы (`ready`)
- Режим должен быть включен в конфигурации

**Сброс счетчика:**
```gcode
_ACE_RESET_INFINITYSPOOL
```

---

## Интеграция со слайсерами

### PrusaSlicer / SuperSlicer

В настройках принтера добавьте макросы смены инструмента:

**Начало печати:**
```gcode
T0  ; Загрузить слот 0
G28 ; Калибровка
```

**Смена цвета/материала:**
```gcode
T1  ; Сменить на слот 1
```

**Настройка в PrusaSlicer:**
1. Printer Settings → Custom G-code
2. Tool change G-code: `T[current_extruder]`
3. Before layer change G-code: (опционально)

### Cura

**Настройка смены инструмента:**

1. Extensions → Post Processing → Modify G-Code
2. Add Script → Tool Change
3. В поле "Tool Change G-code" добавьте:
```
T[tool]
```

### OrcaSlicer

Аналогично PrusaSlicer - используйте макросы `T0-T3` для смены инструмента.

---

## Типичные сценарии

### Сценарий 1: Первая загрузка филамента

```gcode
# 1. Проверить статус устройства
ACE_STATUS

# 2. Загрузить филамент из слота 0
T0

# 3. Проверить, что филамент загружен
ACE_STATUS
```

### Сценарий 2: Многокрасочная печать

**Подготовка:**
```gcode
# Загрузить все необходимые цвета
T0  # Красный
T1  # Синий
T2  # Желтый
```

**В слайсере:**
- Настройте смену инструмента через макросы `T0-T3`
- Каждый слой/секция будет использовать соответствующий инструмент

### Сценарий 3: Сушка филамента перед печатью

```gcode
# 1. Запустить сушку на 2 часа
ACE_START_DRYING TEMP=50 DURATION=120

# 2. Проверить статус (можно периодически)
ACE_STATUS

# 3. После завершения сушки - загрузить филамент
T0
```

### Сценарий 4: Замена пустого филамента

```gcode
# 1. Обнаружение пустого слота (автоматически через _ACE_ON_EMPTY_ERROR)
# Печать паузится

# 2. Загрузить новый филамент
T1  # Загрузить из слота 1

# 3. Продолжить печать
RESUME
```

### Сценарий 5: Использование infinity spool

**Настройка:**
```ini
# В ace.cfg
infinity_spool_mode: True
```

**Использование:**
```gcode
# Когда филамент закончился
ACE_INFINITY_SPOOL

# Автоматически переключится на следующий готовый слот
```

### Сценарий 6: Ручная подача/откат для прочистки

```gcode
# Подать филамент для прочистки
ACE_FEED INDEX=0 LENGTH=100 SPEED=20

# Откатить обратно
ACE_RETRACT INDEX=0 LENGTH=100 SPEED=25
```

---

## Мониторинг и диагностика

### Проверка статуса устройства

```gcode
ACE_STATUS
```

**Что смотреть:**
- `status` - состояние устройства (`ready`, `busy`, `disconnected`)
- `slots` - информация о каждом слоте
- `dryer` - статус сушилки
- `temp` - текущая температура

### Проверка информации о филаменте

```gcode
ACE_FILAMENT_INFO INDEX=0
```

Работает только для филаментов с RFID метками.

### Отладочные команды

```gcode
# Получить информацию об устройстве
ACE_DEBUG METHOD=get_info

# Получить статус
ACE_DEBUG METHOD=get_status
```

### Просмотр логов

```bash
# Просмотр логов Klipper
tail -f ~/printer_data/logs/klippy.log | grep -i ace

# Просмотр с фильтром по уровню
tail -f ~/printer_data/logs/klippy.log | grep -i "ace.*debug"
```

---

## Рекомендации по использованию

### Перед началом печати

1. ✅ Проверьте статус всех слотов: `ACE_STATUS`
2. ✅ Убедитесь, что нужные слоты заполнены и готовы
3. ✅ При необходимости просушите филамент
4. ✅ Загрузите нужный инструмент: `T0` (или другой)

### Во время печати

- Не вмешивайтесь в работу автоматической смены инструмента
- Следите за статусом через веб-интерфейс
- При ошибках - проверьте логи

### После печати

- Можно выгрузить филамент: `TR`
- При необходимости просушить филамент
- Проверить состояние устройства: `ACE_STATUS`

---

## Часто задаваемые вопросы

### Q: Как узнать, какой инструмент сейчас загружен?

**A:** Используйте `ACE_STATUS` и проверьте переменную `ace_current_index` через `SAVE_VARIABLE` или посмотрите в логах.

### Q: Можно ли использовать только некоторые слоты?

**A:** Да, используйте только нужные слоты. Остальные должны быть пустыми или неиспользуемыми.

### Q: Что делать, если парковка не завершается?

**A:** 
1. Проверьте готовность слота: `ACE_STATUS`
2. Увеличьте `park_hit_count` в конфигурации
3. Проверьте логи на наличие ошибок

### Q: Можно ли использовать ACE с другими MMU?

**A:** ValgACE предназначен специально для Anycubic Color Engine Pro. Для других MMU используйте соответствующие драйверы.

### Q: Как часто нужно проверять статус?

**A:** Обычно не требуется - модуль работает автоматически. Проверяйте только при проблемах или для диагностики.

---

*Дата последнего обновления: 2024*

