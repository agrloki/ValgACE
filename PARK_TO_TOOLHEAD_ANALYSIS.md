# –ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ `cmd_ACE_PARK_TO_TOOLHEAD`

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ—Ü–µ—Å—Å–∞)
2. [–í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞: `cmd_ACE_PARK_TO_TOOLHEAD`](#–≤—Ö–æ–¥–Ω–∞—è-—Ç–æ—á–∫–∞)
3. [–û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: `_park_to_toolhead`](#–æ—Å–Ω–æ–≤–Ω–∞—è-–ª–æ–≥–∏–∫–∞)
4. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞: `_handle_response`](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–ø—Ä–æ—Ü–µ—Å—Å–∞)
5. [–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏: `_complete_parking`](#–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ-–ø–∞—Ä–∫–æ–≤–∫–∏)
6. [–°–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ñ–ª–∞–≥–∏](#—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∏-—Ñ–ª–∞–≥–∏)
7. [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º ACE](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º)
8. [–î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π](#–¥–∏–∞–≥—Ä–∞–º–º–∞-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
9. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

**–ü–∞—Ä–∫–æ–≤–∫–∞ —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞** - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∞—á–∏ —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞ –∏–∑ —Å–ª–æ—Ç–∞ ACE –¥–æ —Å–æ–ø–ª–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞. –ü—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å—á–µ—Ç—á–∏–∫ `feed_assist_count`, –∫–æ—Ç–æ—Ä—ã–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º "—É–¥–∞—Ä–µ" —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞ –æ –∫–æ–Ω—Ü–µ–≤–æ–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å –≤ —Å–æ–ø–ª–µ.

**–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è:**
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `feed_assist` –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
2. –§–∏–ª–∞–º–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–¥–∞–≤–∞—Ç—å—Å—è
3. –ö–æ–≥–¥–∞ —Ñ–∏–ª–∞–º–µ–Ω—Ç –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Å–æ–ø–ª–∞, —Å—á–µ—Ç—á–∏–∫ `feed_assist_count` –Ω–∞—á–∏–Ω–∞–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è
4. –ö–æ–≥–¥–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è N —Ä–∞–∑ –ø–æ–¥—Ä—è–¥), –ø–∞—Ä–∫–æ–≤–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π

---

## –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞: `cmd_ACE_PARK_TO_TOOLHEAD`

```python
def cmd_ACE_PARK_TO_TOOLHEAD(self, gcmd):
    if self._park_in_progress:
        gcmd.respond_raw("Already parking to toolhead")
        return
    index = gcmd.get_int('INDEX', minval=0, maxval=3)
    if self._info['slots'][index]['status'] != 'ready':
        self.gcode.run_script_from_command(f"_ACE_ON_EMPTY_ERROR INDEX={index}")
        return
    self._park_to_toolhead(index)
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –ø–∞—Ä–∫–æ–≤–∫—É** (—Å—Ç—Ä–æ–∫–∞ 639-641)
   - –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä–∫–æ–≤–∫–∏ (`_park_in_progress == True`), –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ INDEX** (—Å—Ç—Ä–æ–∫–∞ 642)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω: 0-3
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞** (—Å—Ç—Ä–æ–∫–∞ 643-645)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–ª–æ—Ç–∞: `self._info['slots'][index]['status']`
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ `'ready'`, –≤—ã–∑—ã–≤–∞–µ—Ç –º–∞–∫—Ä–æ—Å `_ACE_ON_EMPTY_ERROR`
   - –≠—Ç–æ—Ç –º–∞–∫—Ä–æ—Å –æ–±—ã—á–Ω–æ –ø–∞—É–∑–∏—Ç –ø–µ—á–∞—Ç—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

4. **–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–∞—Ä–∫–æ–≤–∫–∏** (—Å—Ç—Ä–æ–∫–∞ 646)
   - –í—ã–∑—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ñ—É–Ω–∫—Ü–∏—é `_park_to_toolhead(index)`

### –ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–∞:

```gcode
ACE_PARK_TO_TOOLHEAD INDEX=0   # –ü–∞—Ä–∫–æ–≤–∫–∞ —Å–ª–æ—Ç–∞ 0
ACE_PARK_TO_TOOLHEAD INDEX=2   # –ü–∞—Ä–∫–æ–≤–∫–∞ —Å–ª–æ—Ç–∞ 2
```

---

## –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: `_park_to_toolhead`

```python
def _park_to_toolhead(self, index: int):
    # Set parking flag BEFORE sending request to ensure timers see it
    self._park_in_progress = True
    self._park_error = False  # Reset error flag
    self._park_index = index
    self._assist_hit_count = 0
    self._park_start_time = self.reactor.monotonic()
    self._park_count_increased = False  # Track if count actually increased
    
    self.logger.info(f"Starting parking for slot {index}")
    
    def callback(response):
        if response.get('code', 0) != 0:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–ø—É—Å–∫–∞ feed_assist
            if 'result' in response and 'msg' in response['result']:
                self.logger.error(f"ACE Error starting feed assist: {response['result']['msg']}")
            else:
                self.logger.error(f"ACE Error starting feed assist: {response.get('msg', 'Unknown error')}")
            # Reset parking flag on error since device won't start feeding
            self._park_in_progress = False
            self.logger.error(f"Parking aborted for slot {index} due to start_feed_assist error")
        else:
            self._last_assist_count = response.get('result', {}).get('feed_assist_count', 0)
            self.logger.info(f"Feed assist started for slot {index}, count: {self._last_assist_count}")
        self.dwell(0.3, lambda: None)
    self.send_request({"method": "start_feed_assist", "params": {"index": index}}, callback)
```

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 614-619):

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:** –§–ª–∞–≥–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è **–î–û** –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã —Ç–∞–π–º–µ—Ä—ã –º–æ–≥–ª–∏ –∏—Ö —É–≤–∏–¥–µ—Ç—å!

```python
self._park_in_progress = True      # –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞—Ä–∫–æ–≤–∫–∏
self._park_error = False           # –§–ª–∞–≥ –æ—à–∏–±–∫–∏ (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)
self._park_index = index           # –ò–Ω–¥–µ–∫—Å –ø–∞—Ä–∫—É–µ–º–æ–≥–æ —Å–ª–æ—Ç–∞
self._assist_hit_count = 0         # –°—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
self._park_start_time = ...        # –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–∞—Ä–∫–æ–≤–∫–∏
self._park_count_increased = False # –§–ª–∞–≥: —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è –ª–∏ —Å—á–µ—Ç—á–∏–∫ —Ö–æ—Ç—å —Ä–∞–∑
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É (—Å—Ç—Ä–æ–∫–∞ 636):

```python
self.send_request({
    "method": "start_feed_assist",
    "params": {"index": index}
}, callback)
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ACE:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥–∞—á–∏ —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞
- –§–∏–ª–∞–º–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Å–æ–ø–ª—É
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Å–æ–ø–ª–∞, —Å—á–µ—Ç—á–∏–∫ `feed_assist_count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

### Callback –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 623-635):

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (`code == 0`):**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `feed_assist_count` –≤ `_last_assist_count`
- –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫
- –î–µ–ª–∞–µ—Ç –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (0.3 —Å–µ–∫) –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏

**–û—à–∏–±–∫–∞ (`code != 0`):**
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
- **–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ `_park_in_progress`** - –ø—Ä–æ—Ü–µ—Å—Å —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- –ü–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–∞

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞: `_handle_response`

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `_handle_response`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:

```python
def _handle_response(self, response: dict):
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤ ...
    
    if 'result' in response and isinstance(response['result'], dict):
        result = response['result']
        self._info.update(result)
        
        if self._park_in_progress:  # ‚Üê –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞
            current_status = result.get('status', 'unknown')
            current_assist_count = result.get('feed_assist_count', 0)
            elapsed_time = self.reactor.monotonic() - self._park_start_time
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            self.logger.debug(f"Parking check: slot {self._park_index}, "
                            f"count={current_assist_count}, "
                            f"last={self._last_assist_count}, "
                            f"hits={self._assist_hit_count}, "
                            f"elapsed={elapsed_time:.1f}s")
```

### –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–π –ø–∞—Ä–∫–æ–≤–∫–∏:

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—Å—Ç—Ä–æ–∫–∞ 414):

```python
if current_status == 'ready':
    # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ 'ready' –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
```

#### 2. –°—á–µ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–∏–ª—Å—è - —Ñ–∏–ª–∞–º–µ–Ω—Ç –¥–≤–∏–∂–µ—Ç—Å—è (—Å—Ç—Ä–æ–∫–∏ 415-423):

```python
if current_assist_count != self._last_assist_count:
    self._last_assist_count = current_assist_count  # –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    self._assist_hit_count = 0                       # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    
    if current_assist_count > 0:
        self._park_count_increased = True  # ‚Üê –í–ê–ñ–ù–û: —Ñ–∏–ª–∞–º–µ–Ω—Ç –¥–æ—Å—Ç–∏–≥ —Å–æ–ø–ª–∞!
        self.logger.info(f"Feed assist working for slot {self._park_index}, "
                        f"count: {current_assist_count}")
```

**–ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:**
- –§–∏–ª–∞–º–µ–Ω—Ç –¥–æ—Å—Ç–∏–≥ —Å–æ–ø–ª–∞ –∏ —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–ª—Å—è
- –ü—Ä–æ—Ü–µ—Å—Å –∏–¥–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ —Ö–æ—Ç—å —Ä–∞–∑ —É–≤–µ–ª–∏—á–∏–ª—Å—è

#### 3. –°—á–µ—Ç—á–∏–∫ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (—Å—Ç—Ä–æ–∫–∏ 424-450):

```python
else:  # current_assist_count == self._last_assist_count
    self._assist_hit_count += 1  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –§–∏–ª–∞–º–µ–Ω—Ç –Ω–µ –¥–æ—Å—Ç–∏–≥ —Å–æ–ø–ª–∞ –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã
    if elapsed_time > 3.0 and not getattr(self, '_park_count_increased', False):
        self.logger.error(f"Feed assist for slot {self._park_index} not working - "
                         f"count stayed at {current_assist_count}")
        self._park_error = True
        self._park_in_progress = False
        self._park_index = -1
        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å –æ—à–∏–±–∫–æ–π
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –°—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª–µ–Ω N —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
    if self._assist_hit_count >= self.park_hit_count:
        if getattr(self, '_park_count_increased', False):
            self._complete_parking()  # ‚Üê –£–°–ü–ï–•: –ø–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
        else:
            # –°—á–µ—Ç—á–∏–∫ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è - –æ—à–∏–±–∫–∞
            self.logger.warning(f"Parking check completed but count never increased")
            self._park_error = True
            self._park_in_progress = False
```

**–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**

1. **–ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ >3 —Å–µ–∫—É–Ω–¥ –∏ —Å—á–µ—Ç—á–∏–∫ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è:**
   - –§–∏–ª–∞–º–µ–Ω—Ç –Ω–µ –¥–æ—Å—Ç–∏–≥ —Å–æ–ø–ª–∞
   - –û–®–ò–ë–ö–ê - –ø–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
   - –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

2. **–ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª–µ–Ω `park_hit_count` —Ä–∞–∑ –ø–æ–¥—Ä—è–¥:**
   - –§–∏–ª–∞–º–µ–Ω—Ç –¥–æ—Å—Ç–∏–≥ —Å–æ–ø–ª–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
   - –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ —Ö–æ—Ç—å —Ä–∞–∑ —É–≤–µ–ª–∏—á–∏–ª—Å—è ‚Üí –£–°–ü–ï–•
   - –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è ‚Üí –û–®–ò–ë–ö–ê

#### 4. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 448-450):

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–π–º–µ—Ä –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
if not hasattr(self, '_dwell_scheduled') or not self._dwell_scheduled:
    self._dwell_scheduled = True
    self.dwell(0.7, lambda: setattr(self, '_dwell_scheduled', False))
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–æ–≤:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤
- –ü–ª–∞–Ω–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 0.7 —Å–µ–∫—É–Ω–¥

### –ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫:

- **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º:** —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 1.0 —Å–µ–∫—É–Ω–¥—É
- **–†–µ–∂–∏–º –ø–∞—Ä–∫–æ–≤–∫–∏:** —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 0.2 —Å–µ–∫—É–Ω–¥—ã (—Å—Ç—Ä–æ–∫–∞ 368)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:** –∫–∞–∂–¥—ã–µ 0.7 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞

---

## –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏: `_complete_parking`

```python
def _complete_parking(self):
    if not self._park_in_progress:
        return  # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    
    self.logger.info(f"Parking completed for slot {self._park_index}")
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ feed_assist
        self.send_request({
            "method": "stop_feed_assist",
            "params": {"index": self._park_index}
        }, lambda r: None)  # Callback –Ω–µ –Ω—É–∂–µ–Ω
    except Exception as e:
        self.logger.info(f"Parking completion error: {str(e)}")
    finally:
        # –í—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        self._park_in_progress = False
        self._park_error = False
        self._park_is_toolchange = False
        self._park_previous_tool = -1
        self._park_index = -1
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–∫–ª—é—á–∞–µ–º assist –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        if self.disable_assist_after_toolchange:
            self._feed_assist_index = -1
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è** (—Å—Ç—Ä–æ–∫–∞ 453)
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞

2. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞ feed_assist** (—Å—Ç—Ä–æ–∫–∏ 456-460)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `stop_feed_assist` —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
   - –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–¥–∞—á—É —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞

3. **–°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤** (—Å—Ç—Ä–æ–∫–∏ 468-472)
   - `_park_in_progress = False` - –ø–∞—Ä–∫–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
   - `_park_error = False` - –æ—à–∏–±–æ–∫ –Ω–µ—Ç
   - `_park_is_toolchange = False` - —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ —Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
   - `_park_index = -1` - –æ—á–∏—Å—Ç–∫–∞ –∏–Ω–¥–µ–∫—Å–∞

4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** (—Å—Ç—Ä–æ–∫–∞ 473-474)
   - –ï—Å–ª–∏ `disable_assist_after_toolchange == True`, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `_feed_assist_index`

---

## –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ñ–ª–∞–≥–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

| –§–ª–∞–≥ | –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----|------------|
| `_park_in_progress` | `bool` | –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–∞—Ä–∫–æ–≤–∫–∞ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç |
| `_park_error` | `bool` | –ü—Ä–æ–∏–∑–æ—à–ª–∞ –ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∫–æ–≤–∫–µ |
| `_park_index` | `int` | –ò–Ω–¥–µ–∫—Å —Å–ª–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∞—Ä–∫—É–µ—Ç—Å—è (-1 –µ—Å–ª–∏ –Ω–µ—Ç) |
| `_park_start_time` | `float` | –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ (monotonic) |
| `_park_count_increased` | `bool` | –£–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è –ª–∏ —Å—á–µ—Ç—á–∏–∫ —Ö–æ—Ç—å —Ä–∞–∑ |
| `_assist_hit_count` | `int` | –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ —Å—á–µ—Ç—á–∏–∫ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è |
| `_last_assist_count` | `int` | –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ |
| `_park_is_toolchange` | `bool` | –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å—é —Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ |
| `_park_previous_tool` | `int` | –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–¥–ª—è —Å–º–µ–Ω—ã) |

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------------------|----------|
| `park_hit_count` | 5 | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|----------|
| `current_assist_count` | `response['result']['feed_assist_count']` | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| `current_status` | `response['result']['status']` | –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ('ready', 'busy') |
| `elapsed_time` | `monotonic() - _park_start_time` | –ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –ø–∞—Ä–∫–æ–≤–∫–∏ |

---

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º ACE

### –ö–æ–º–∞–Ω–¥—ã RPC:

#### 1. –ó–∞–ø—É—Å–∫ –ø–∞—Ä–∫–æ–≤–∫–∏:
```json
{
  "method": "start_feed_assist",
  "params": {
    "index": 0
  }
}
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```json
{
  "id": <–Ω–æ–º–µ—Ä>,
  "code": 0,
  "msg": "success",
  "result": {
    "feed_assist_count": 0  // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  }
}
```

#### 2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:
```json
{
  "method": "get_status"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": <–Ω–æ–º–µ—Ä>,
  "code": 0,
  "msg": "success",
  "result": {
    "status": "ready",
    "feed_assist_count": 5,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —É–¥–∞—Ä–µ
    "slots": [...]
  }
}
```

#### 3. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∫–æ–≤–∫–∏:
```json
{
  "method": "stop_feed_assist",
  "params": {
    "index": 0
  }
}
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

```
[IDLE]
  ‚îÇ
  ‚îÇ cmd_ACE_PARK_TO_TOOLHEAD
  ‚ñº
[–ü–†–û–í–ï–†–ö–ê]
  ‚îÇ
  ‚îú‚îÄ‚Üí –£–∂–µ –ø–∞—Ä–∫—É–µ—Ç—Å—è? ‚îÄ‚îÄ‚Üí [–û–¢–ö–õ–û–ù–ï–ù–û] ‚îÄ‚îÄ‚Üí END
  ‚îÇ
  ‚îú‚îÄ‚Üí –°–ª–æ—Ç –Ω–µ –≥–æ—Ç–æ–≤? ‚îÄ‚îÄ‚Üí [–û–®–ò–ë–ö–ê] ‚îÄ‚îÄ‚Üí END
  ‚îÇ
  ‚îî‚îÄ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è OK
       ‚îÇ
       ‚ñº
[–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø]
  ‚îÇ
  ‚îÇ _park_to_toolhead()
  ‚îÇ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–æ–≤
  ‚îÇ –û—Ç–ø—Ä–∞–≤–∫–∞ start_feed_assist
  ‚îÇ
  ‚ñº
[–û–ñ–ò–î–ê–ù–ò–ï –û–¢–í–ï–¢–ê]
  ‚îÇ
  ‚îú‚îÄ‚Üí –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ ‚îÄ‚îÄ‚Üí [–û–®–ò–ë–ö–ê] ‚îÄ‚îÄ‚Üí END
  ‚îÇ
  ‚îî‚îÄ‚Üí –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫
       ‚îÇ
       ‚ñº
[–ú–û–ù–ò–¢–û–†–ò–ù–ì]
  ‚îÇ
  ‚îÇ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç—É—Å–∞ (–∫–∞–∂–¥—ã–µ 0.2 —Å–µ–∫)
  ‚îÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ feed_assist_count
  ‚îÇ
  ‚îú‚îÄ‚Üí –°—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–ª—Å—è ‚îÄ‚îÄ‚Üí [–§–ò–õ–ê–ú–ï–ù–¢ –î–í–ò–ñ–ï–¢–°–Ø]
  ‚îÇ                            ‚îÇ
  ‚îÇ                            ‚îî‚îÄ‚Üí _park_count_increased = True
  ‚îÇ
  ‚îú‚îÄ‚Üí –°—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª–µ–Ω N —Ä–∞–∑ ‚îÄ‚îÄ‚Üí [–°–¢–ê–ë–ò–õ–ò–ó–ê–¶–ò–Ø]
  ‚îÇ                              ‚îÇ
  ‚îÇ                              ‚îú‚îÄ‚Üí –°—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è? ‚îÄ‚îÄ‚Üí [–£–°–ü–ï–•]
  ‚îÇ                              ‚îÇ                              ‚îÇ
  ‚îÇ                              ‚îÇ                              ‚ñº
  ‚îÇ                              ‚îÇ                            [–ó–ê–í–ï–†–®–ï–ù–ò–ï]
  ‚îÇ                              ‚îÇ                              ‚îÇ
  ‚îÇ                              ‚îÇ                              ‚îÇ _complete_parking()
  ‚îÇ                              ‚îÇ                              ‚îÇ stop_feed_assist
  ‚îÇ                              ‚îÇ                              ‚îÇ –°–±—Ä–æ—Å —Ñ–ª–∞–≥–æ–≤
  ‚îÇ                              ‚îÇ                              ‚îÇ
  ‚îÇ                              ‚îÇ                              ‚ñº
  ‚îÇ                              ‚îÇ                            [IDLE]
  ‚îÇ                              ‚îÇ
  ‚îÇ                              ‚îî‚îÄ‚Üí –°—á–µ—Ç—á–∏–∫ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–ª—Å—è? ‚îÄ‚îÄ‚Üí [–û–®–ò–ë–ö–ê]
  ‚îÇ
  ‚îî‚îÄ‚Üí –ü—Ä–æ—à–ª–æ >3 —Å–µ–∫, —Å—á–µ—Ç—á–∏–∫ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è ‚îÄ‚îÄ‚Üí [–û–®–ò–ë–ö–ê]
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞

```gcode
ACE_PARK_TO_TOOLHEAD INDEX=0
```

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–∞—Ä–∫–æ–≤–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ ‚úì
2. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–ª–æ—Ç 0 –≥–æ—Ç–æ–≤ ‚úì
3. –ó–∞–ø—É—Å–∫ `start_feed_assist` –¥–ª—è —Å–ª–æ—Ç–∞ 0
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å 0 ‚Üí 1 ‚Üí 2 ‚Üí 3
5. –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è: —Å—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–µ—Ç—Å—è 3 –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –ø—Ä–æ–≤–µ—Ä–æ–∫
6. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: `stop_feed_assist`, —Ñ–∏–ª–∞–º–µ–Ω—Ç –ø—Ä–∏–ø–∞—Ä–∫–æ–≤–∞–Ω

### –ü—Ä–∏–º–µ—Ä 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

```python
# –í cmd_ACE_CHANGE_TOOL:
self.gcode.run_script_from_command(f'ACE_PARK_TO_TOOLHEAD INDEX={tool}')
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ `_park_is_toolchange = True`
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `_ACE_POST_TOOLCHANGE`
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω `feed_assist` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 3: –û—à–∏–±–∫–∞ - —Å–ª–æ—Ç –ø—É—Å—Ç

```gcode
ACE_PARK_TO_TOOLHEAD INDEX=2
```

**–ï—Å–ª–∏ —Å–ª–æ—Ç 2 –ø—É—Å—Ç:**
```
self._info['slots'][2]['status'] == 'empty'  # –ù–µ 'ready'
‚Üí –í—ã–∑–æ–≤ _ACE_ON_EMPTY_ERROR
‚Üí –ü–µ—á–∞—Ç—å –ø–∞—É–∑–∏—Ç—Å—è (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞)
‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
```

---

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Klipper reactor –¥–ª—è —Ç–∞–π–º–µ—Ä–æ–≤
- Callback'–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –∑–∞–≤–∏—Å–∞–Ω–∏—è (3 —Å–µ–∫—É–Ω–¥—ã)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫

### 3. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫

- –û–±—ã—á–Ω–æ: 1.0 —Å–µ–∫
- –ü—Ä–∏ –ø–∞—Ä–∫–æ–≤–∫–µ: 0.2 —Å–µ–∫ (–≤ 5 —Ä–∞–∑ —á–∞—â–µ!)
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 4. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

- –ü—Ä–æ–≤–µ—Ä–∫–∞ `_park_in_progress` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
- –§–ª–∞–≥ `_dwell_scheduled` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã

---

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Race condition –≤ `_handle_response`

–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è callback'–æ–≤. –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏).

### 2. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã

- 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ–ø–ª–∞
- `park_hit_count` —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ú–æ–∂–µ—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### 3. –ù–µ—Ç —è–≤–Ω–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–∞ –ø–∞—Ä–∫–æ–≤–∫–∏

–ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–∏—Å–Ω–µ—Ç, –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ (—Ö–æ—Ç—è –µ—Å—Ç—å –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞).

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

1. **–î–æ–±–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –ø–∞—Ä–∫–æ–≤–∫–∏:**
   ```python
   MAX_PARK_TIMEOUT = 60.0  # —Å–µ–∫—É–Ω–¥
   if elapsed_time > MAX_PARK_TIMEOUT:
       # –ü—Ä–µ—Ä–≤–∞—Ç—å –ø–∞—Ä–∫–æ–≤–∫—É
   ```

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:**
   - –í—Ä–µ–º—è –ø–∞—Ä–∫–æ–≤–∫–∏
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞—Ä–æ–≤
   - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏

3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ —Ç–∞–π–º–∞—É—Ç—ã:**
   - –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ–ø–ª–∞
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–∞—Ä–∫–æ–≤–∫–∏

---

*–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2024*  
*–í–µ—Ä—Å–∏—è: ace.py (957 —Å—Ç—Ä–æ–∫)*

