# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ ValgACE

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è](#–æ–±—â–∞—è-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞](#–∞–Ω–∞–ª–∏–∑-–∫–æ–¥–∞)
4. [–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏](#–∞–Ω–∞–ª–∏–∑-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞-–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏)
5. [–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏](#–∞–Ω–∞–ª–∏–∑-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
6. [–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](#–∞–Ω–∞–ª–∏–∑-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
7. [–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#–≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)
8. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—É–ª—É—á—à–µ–Ω–∏—é)

---

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**ValgACE** - –º–æ–¥—É–ª—å –¥–ª—è Klipper, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º Anycubic Color Engine Pro (ACE) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã —Ñ–∏–ª–∞–º–µ–Ω—Ç–∞.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
- **–Ø–∑—ã–∫**: Python 3
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: pyserial (–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ requirements.txt!)
- **–§—Ä–µ–π–º–≤–æ—Ä–∫**: Klipper
- **–ü—Ä–æ—Ç–æ–∫–æ–ª**: USB CDC —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º –ø–æ–≤–µ—Ä—Ö JSON
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤**: 4 (–∏–Ω–¥–µ–∫—Å—ã 0-3)
- **–°—Ç–∞—Ç—É—Å**: –í —Å—Ç–∞–¥–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
```
ValgACE/
‚îú‚îÄ‚îÄ extras/
‚îÇ   ‚îú‚îÄ‚îÄ ace.py           # –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å (1006 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ testmacro.cfg    # –¢–µ—Å—Ç–æ–≤—ã–µ –º–∞–∫—Ä–æ—Å—ã
‚îú‚îÄ‚îÄ ace.cfg              # –ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ ace.cfg.sample       # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ install.sh           # –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (v1.2)
‚îú‚îÄ‚îÄ requirements.txt     # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (‚ö†Ô∏è –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ!)
‚îú‚îÄ‚îÄ README.md            # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Manual.md            # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ Protocol.md          # –ü—Ä–æ—Ç–æ–∫–æ–ª (EN)
‚îú‚îÄ‚îÄ Protocol_ru.md       # –ü—Ä–æ—Ç–æ–∫–æ–ª (RU)
‚îú‚îÄ‚îÄ LICENSE.md           # GPL v3
‚îî‚îÄ‚îÄ –ó–∞–º–µ—á–∞–Ω–∏—è            # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
- **Event-driven architecture** —á–µ—Ä–µ–∑ Klipper reactor
- **Callback-based** RPC —Å–∏—Å—Ç–µ–º–∞
- **Queue-based** –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 2.1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å `ValgAce`
- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Klipper
- **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª**: –°–≤—è–∑–∞–Ω —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º Klipper
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —è–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

#### 2.2. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Reader loop**: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ serial –ø–æ—Ä—Ç–∞ (timer-based)
- **Writer loop**: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ keep-alive (timer-based)
- **Queue**: –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ (thread-safe `queue.Queue`)

#### 2.3. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (`self._info`)
- –ö–∞—Ä—Ç–∞ callback'–æ–≤ (`self._callback_map`)
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏ (`self._park_*`)

### 3. –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π ‚Üí –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Üí 
  ‚Üì (—É—Å–ø–µ—Ö)
–ó–∞–ø—É—Å–∫ reader/writer loops ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ ‚Üí 
  ‚Üì (–æ—à–∏–±–∫–∞)
–ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)
```

---

## –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

### 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞

- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫**: 1006
- **–ú–µ—Ç–æ–¥–æ–≤**: ~44 (–≤–∫–ª—é—á–∞—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ `_` –∏ –∫–æ–º–∞–Ω–¥—ã `cmd_`)
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–π**: 41 –±–ª–æ–∫ try/except
- **G-code –∫–æ–º–∞–Ω–¥**: 15 –∫–æ–º–∞–Ω–¥

### 2. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

#### 2.1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Klipper API
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ reactor –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π  
‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π  
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ callback'–æ–≤ –¥–ª—è RPC  
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å toolhead –∏ gcode

#### 2.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π  
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥

#### 2.3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚úÖ –ê–≤—Ç–æ–ø–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ VID/PID  
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 4 —Å–ª–æ—Ç–æ–≤  
‚úÖ –†–µ–∂–∏–º –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –∫–∞—Ç—É—à–∫–∏ (infinity_spool)  
‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—à–∫–æ–π  
‚úÖ –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏ —á–µ—Ä–µ–∑ —Å—á–µ—Ç—á–∏–∫

### 3. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 3.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
```python
# requirements.txt —Å–æ–¥–µ—Ä–∂–∏—Ç:
pyjson==1.4.1

# –ù–æ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
import serial  # pyserial!
```
**–í–ª–∏—è–Ω–∏–µ**: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**üî¥ –ü–†–û–ë–õ–ï–ú–ê #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞**
```python
# –í _send_request –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
packet = (
    bytes([0xFF, 0xAA]) +
    struct.pack('<H', len(payload)) +
    payload +
    struct.pack('<H', crc) +
    bytes([0xFE])
)
# Protocol.md –≥–æ–≤–æ—Ä–∏—Ç: –∫–∞–¥—Ä—ã >1024 –±–∞–π—Ç –±–ª–æ–∫–∏—Ä—É—é—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ!
```
**–í–ª–∏—è–Ω–∏–µ**: –†–∏—Å–∫ –∑–∞–≤–∏—Å–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

**üî¥ –ü–†–û–ë–õ–ï–ú–ê #3: Race condition –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–æ–≤**
```python
# –í _handle_response:
if 'id' in response:
    callback = self._callback_map.pop(response['id'], None)  # –ù–µ –∞—Ç–æ–º–∞—Ä–Ω–æ!
```
**–í–ª–∏—è–Ω–∏–µ**: –í–æ–∑–º–æ–∂–Ω–∞ –ø–æ—Ç–µ—Ä—è callback'–æ–≤ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

#### 3.2. –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**üü° –ü–†–û–ë–õ–ï–ú–ê #4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤**
```python
# –í _connect –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è dwell –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
self.dwell(1.0, lambda: None)  # –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ —Ü–∏–∫–ª–µ!
```
**–í–ª–∏—è–Ω–∏–µ**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**üü° –ü–†–û–ë–õ–ï–ú–ê #5: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç–∞–π–º–µ—Ä–æ–≤**
```python
# –í _request_status –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:
if self.reactor.monotonic() - self._last_status_request > ...
    # –ò –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞!
if self.reactor.monotonic() - self._last_status_request > ...
```
**–í–ª–∏—è–Ω–∏–µ**: –ò–∑–±—ã—Ç–æ—á–Ω—ã–π –∫–æ–¥, –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

**üü° –ü–†–û–ë–õ–ï–ú–ê #6: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –º–µ—Ç–æ–¥**
```python
def _wait_for_slot_ready(self, index, on_ready, event_time):
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–µ—Å—Ç—å _wait_for_slot_ready_async)
```
**–í–ª–∏—è–Ω–∏–µ**: –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥

**üü° –ü–†–û–ë–õ–ï–ú–ê #7: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**
```python
# –í cmd_ACE_UPDATE_RETRACT_SPEED:
speed = gcmd.get_int('SPEED', self.feed_speed, minval=1)
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å self.retract_speed, –∞ –Ω–µ self.feed_speed!
```
**–í–ª–∏—è–Ω–∏–µ**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**üü° –ü–†–û–ë–õ–ï–ú–ê #8: –ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ CRC**
```python
# –í _process_messages:
if crc != self._calc_crc(payload):
    return  # –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è!
```
**–í–ª–∏—è–Ω–∏–µ**: –¢–∏—Ö–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

#### 3.3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

**üü¢ –£–õ–£–ß–®–ï–ù–ò–ï #1: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ CRC –Ω–∞ 0xFFAA**
```python
# Protocol.md —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å CRC != 0xFFAA
# –í –∫–æ–¥–µ –Ω–µ—Ç —Ç–∞–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
```

**üü¢ –£–õ–£–ß–®–ï–ù–ò–ï #2: –•–∞—Ä–¥–∫–æ–¥ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ø–∞—Ä–∫–æ–≤–∫–∏**
```python
# –í cmd_ACE_CHANGE_TOOL:
self.dwell(15.0, after_park_delay)  # –ú–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ
# –í _on_slot_ready_callback:
self.dwell(10.0, after_park_delay)   # –î—Ä—É–≥–æ–µ –º–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ
```

**üü¢ –£–õ–£–ß–®–ï–ù–ò–ï #3: –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ —á—Ç–µ–Ω–∏—è**
```python
# –í _reader_loop:
raw_bytes = self._serial.read(16)  # –ú–∞–ª–µ–Ω—å–∫–∏–π –±—É—Ñ–µ—Ä
# –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
```

**üü¢ –£–õ–£–ß–®–ï–ù–ò–ï #4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤**
```python
# –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
# –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ KeyError –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö
```

### 4. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

#### 4.1. –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã
- ‚úÖ –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ type hints (—á–∞—Å—Ç–∏—á–Ω–æ)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ (—á–∞—Å—Ç–∏—á–Ω–æ)
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

#### 4.2. –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
- ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- ‚ö†Ô∏è –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –±–µ–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
- ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö
- ‚ö†Ô∏è –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏

### 1. –§–æ—Ä–º–∞—Ç –∫–∞–¥—Ä–æ–≤

```
[0xFF 0xAA][2 –±–∞–π—Ç–∞ –¥–ª–∏–Ω–∞][JSON][2 –±–∞–π—Ç–∞ CRC][0xFE]
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è CRC-16/MCRF4XX
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ little-endian
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞ (<1024 –±–∞–π—Ç)
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç CRC = 0xFFAA

### 2. RPC –ø—Ä–æ—Ç–æ–∫–æ–ª

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "id": <–Ω–æ–º–µ—Ä>,
  "method": "<–∏–º—è>",
  "params": {...}
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": <–Ω–æ–º–µ—Ä>,
  "result": {...},
  "code": <–∫–æ–¥>,
  "msg": "<—Å–æ–æ–±—â–µ–Ω–∏–µ>"
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ code
- ‚ö†Ô∏è –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- ‚ö†Ô∏è –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

### 3. Keep-alive –º–µ—Ö–∞–Ω–∏–∑–º

- **–ß–∞—Å—Ç–æ—Ç–∞**: –ö–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É (–∏–ª–∏ 0.2—Å –ø—Ä–∏ –ø–∞—Ä–∫–æ–≤–∫–µ)
- **–ú–µ—Ç–æ–¥**: `get_status`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ timer
- ‚ö†Ô∏è –ù–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –°–±—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
- ‚ö†Ô∏è –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è –ù–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã [ace]

**–û—Å–Ω–æ–≤–Ω—ã–µ:**
- `serial`: –ü—É—Ç—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É (–∞–≤—Ç–æ–ø–æ–∏—Å–∫)
- `baud`: –°–∫–æ—Ä–æ—Å—Ç—å –æ–±–º–µ–Ω–∞ (115200)

**–¢–∞–π–º–∞—É—Ç—ã:**
- `response_timeout`: 2.0s (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `read_timeout`: 0.1s
- `write_timeout`: 0.5s
- `max_queue_size`: 20

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- `feed_speed`: 25 –º–º/—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50 –≤ –∫–æ–¥–µ!)
- `retract_speed`: 25 –º–º/—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50 –≤ –∫–æ–¥–µ!)
- `retract_mode`: 0 (normal) / 1 (enhanced)
- `toolchange_retract_length`: 100 –º–º
- `park_hit_count`: 5
- `max_dryer_temperature`: 55¬∞C
- `disable_assist_after_toolchange`: True/False
- `infinity_spool_mode`: True/False

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê**: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–æ–¥–µ –∏ –∫–æ–Ω—Ñ–∏–≥–µ!

### 2. –ú–∞–∫—Ä–æ—Å—ã G-code

**–°–∏—Å—Ç–µ–º–Ω—ã–µ:**
- `_ACE_PRE_TOOLCHANGE` / `_ACE_POST_TOOLCHANGE`
- `_ACE_PRE_INFINITYSPOOL` / `_ACE_POST_INFINITYSPOOL`
- `_ACE_RESET_INFINITYSPOOL`
- `_ACE_ON_EMPTY_ERROR`

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ:**
- `ACE_STATUS`, `ACE_DEBUG`, `ACE_FILAMENT_INFO`
- `ACE_FEED`, `ACE_RETRACT`, `ACE_STOP_FEED`, `ACE_STOP_RETRACT`
- `ACE_UPDATE_FEEDING_SPEED`, `ACE_UPDATE_RETRACT_SPEED`
- `ACE_CHANGE_TOOL`, `ACE_INFINITY_SPOOL`
- `ACE_PARK_TO_TOOLHEAD`
- `ACE_ENABLE_FEED_ASSIST`, `ACE_DISABLE_FEED_ASSIST`
- `ACE_START_DRYING`, `ACE_STOP_DRYING`
- `T0-T3`, `TR` (–∞–ª–∏–∞—Å—ã)

### 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- `save_variables` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `respond` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### 1. README.md

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RU/EN

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–∂–∏–º–µ infinity_spool
- ‚ö†Ô∏è –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### 2. Manual.md

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –†–∞–∑–¥–µ–ª —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚ö†Ô∏è –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º

### 3. Protocol.md / Protocol_ru.md

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–∞–¥—Ä–æ–≤
- ‚úÖ –°–ø–∏—Å–æ–∫ –º–µ—Ç–æ–¥–æ–≤ RPC

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

### 4. requirements.txt

**üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å!
- –£–∫–∞–∑–∞–Ω–æ: `pyjson==1.4.1`
- –ù—É–∂–Ω–æ: `pyserial>=3.5`

---

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** –≤ requirements.txt
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞** –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
3. **Race condition** –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback'–æ–≤
4. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** –º–µ–∂–¥—É –∫–æ–¥–æ–º –∏ –∫–æ–Ω—Ñ–∏–≥–æ–º

### –í–∞–∂–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)

5. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π `dwell` –≤ —Ü–∏–∫–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
6. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Ç–∞–π–º–∞—É—Ç–æ–≤
7. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ `cmd_ACE_UPDATE_RETRACT_SPEED`
8. –ù–µ–ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ CRC
9. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –º–µ—Ç–æ–¥ `_wait_for_slot_ready`
10. –•–∞—Ä–¥–∫–æ–¥ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ø–∞—Ä–∫–æ–≤–∫–∏

### –£–ª—É—á—à–µ–Ω–∏—è (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

11. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ CRC != 0xFFAA
12. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ —á—Ç–µ–Ω–∏—è
13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤
14. –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫
15. –ù–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```python
# requirements.txt –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
pyserial>=3.5
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞

```python
def _send_request(self, request: Dict[str, Any]) -> bool:
    payload = json.dumps(request).encode('utf-8')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
    if len(payload) > 1024:
        self.logger.error(f"Packet too large: {len(payload)} bytes")
        return False
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç race condition

```python
import threading

def __init__(self, config):
    # ...
    self._callback_lock = threading.Lock()
    
def _handle_response(self, response: dict):
    if 'id' in response:
        with self._callback_lock:
            callback = self._callback_map.pop(response['id'], None)
```

### 4. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª

```python
class ValgAce:
    MAX_PACKET_SIZE = 1024
    PARK_TIMEOUT_DEFAULT = 30.0
    PARK_TIMEOUT_INITIAL = 15.0
    PARK_TIMEOUT_CALLBACK = 10.0
    MAX_INCOMPLETE_MESSAGES = 10
```

### 5. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```python
# –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
self._error_count = 0
self._last_error_time = 0

# –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff
def _get_backoff_delay(self):
    return min(60.0, 2.0 ** self._error_count)
```

### 6. –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
self.logger.debug("Protocol: sending packet", extra={'size': len(packet)})
self.logger.warning("CRC mismatch", extra={'expected': crc, 'got': calc_crc})
```

### 7. –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

```python
def _validate_response(self, response: dict) -> bool:
    required_fields = ['id', 'code', 'msg']
    return all(field in response for field in required_fields)
```

### 8. –£–ª—É—á—à–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- –û–±–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∂–∏–º–∞ infinity_spool
- –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "Troubleshooting"
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### –°–ª–æ–∂–Ω–æ—Å—Ç—å
- **–¶–∏–∫–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –º–µ—Ç–æ–¥–æ–≤ 1-5)
- **–°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: `cmd_ACE_CHANGE_TOOL` (~150 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏)
- **–°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: `cmd_ACE_INFINITY_SPOOL` (~100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏)

### –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚ö†Ô∏è –ù–µ—Ç unit-—Ç–µ—Å—Ç–æ–≤
- ‚ö†Ô∏è –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Klipper
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤
- ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

**–û—Ü–µ–Ω–∫–∞: 7/10**

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è Klipper
- ‚úÖ –•–æ—Ä–æ—à–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—á–∞—Å—Ç–∏—á–Ω–æ)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ —Ä–∞–±–æ—Ç—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- üî¥ –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- üî¥ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
- üî¥ Race conditions
- üü° –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å requirements.txt
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race conditions
4. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª
5. –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
6. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ unit-—Ç–µ—Å—Ç–æ–≤

---

*–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 2024*  
*–í–µ—Ä—Å–∏—è –∫–æ–¥–∞: —Ç–µ–∫—É—â–∞—è (ace.py, 1006 —Å—Ç—Ä–æ–∫)*

